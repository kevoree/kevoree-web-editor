"use strict";angular.module("editorApp",["ngAnimate","ngTouch","ui.router","ui.bootstrap","ui.codemirror","ui.utils","ui-notification","cfp.hotkeys","ngDragDrop","hljs","infinite-scroll"]).run(["$rootScope","$stateParams","kEditor","kFactory","kRegistry","kWs","Notification","VERSION",function(a,b,c,d,e,f,g,h){a.VERSION=h,a.dndLoad=function(a,b){var e,f=c.getModel(),h=d.createJSONLoader();try{e=h.loadModelFromString(b).get(0)}catch(b){return console.error("[app.dndLoad()] Error loading model file"),console.error(b.stack),g.error({title:"Open from file (dnd)",message:"Unable to load a model from <strong>"+a+"</strong>"}),void c.setModel(f)}c.setModel(e,function(b){b?g.error({title:"Open from file (dnd)",message:"Unable to load model from <strong>"+a+"</strong><br/>"+b.message,delay:15e3}):g.success({title:"Open from file (dnd)",message:"Model loaded from <strong>"+a+"</strong>"})})},a.keys=function(a){return!!angular.isObject(a)&&Object.keys(a)},angular.element("#bootstrap-container").fadeOut(function(){this.remove(),b.host&&f.getModel(b.host,b.port||9e3,b.path||"",function(a,b,d){a?g.error({title:"Open from node",message:"Unable to load model from <strong>"+d+"</strong>"}):(c.setModel(b),g.success({title:"Open from node",message:"Model loaded from <strong>"+d+"</strong>"}))})})}]).config(["$stateProvider","$urlRouterProvider","hotkeysProvider","hljsServiceProvider","NotificationProvider",function(a,b,c,d,e){b.otherwise("/"),a.state("app",{abstract:!0,url:"?host&port&path",views:{"navbar@":{templateUrl:"scripts/app/navbar/navbar.html",controller:"NavBarCtrl"}}}),c.template='<div class="editor-shortcuts" ng-include src="\'scripts/components/util/hotkeys.html\'" data-ng-if="helpVisible"></div>',d.setOptions({tabReplace:"  "}),e.setOptions({startTop:90,replaceMessage:!0,delay:5e3})}]),angular.module("editorApp").constant("APP_NAME","Kevoree Web Editor").constant("VERSION","5.12.15").constant("NPM_REGISTRY_URL","http://registry.npmjs.org/{name}/-/{name}-{version}.tgz").constant("KWE_POSITION","kwe_position").constant("KWE_FOLDED","kwe_folded").constant("KWE_TAG","kwe_tag").constant("KWE_SELECTED","kwe_selected").constant("KEVOREE_REGISTRY_URL","https://registry.kevoree.org"),angular.module("editorApp").config(["$stateProvider",function(a){a.state("main",{parent:"app",url:"/",views:{"content@":{templateUrl:"scripts/app/main/main.html",controller:"MainCtrl"},"typedefs@main":{templateUrl:"scripts/app/main/typedefs/typedefs.html",controller:"TypedefsCtrl"},"editor@main":{templateUrl:"scripts/app/main/editor/editor.html",controller:"EditorCtrl"},"instance@main":{templateUrl:"scripts/app/main/instance/instance.html",controller:"InstanceCtrl"}}})}]),angular.module("editorApp").controller("MainCtrl",["$scope","$timeout","$stateParams","$modal","kEditor","hotkeys","saveFile","ui","kModelHelper","kFactory","kWs","Notification",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(){e.drawModel()}var n=e.addNewModelListener("main",m);a.synced=!1;var o;a.onFileLoaded=function(){},a.open=function(b){b.preventDefault(),a.onFileLoaded=function(a,b){var c,d=e.getModel(),f=j.createJSONLoader();try{c=f.loadModelFromString(b).get(0)}catch(b){return console.warn("[main.controller.open()] Error loading model file"),console.error(b.stack),l.error({title:"Open from file",message:"Unable to load a model from <strong>"+a+"</strong>",delay:15e3}),void e.setModel(d)}e.setModel(c,function(b){b?l.error({title:"Open from file",message:"Unable to open model <strong>"+a+"</strong><br/>"+b.message,delay:15e3}):l.success({title:"Open from file",message:"Model loaded from <strong>"+a+"</strong>"})})},angular.element("input#file").click()},a.merge=function(b){b.preventDefault(),a.onFileLoaded=function(a,b){var c,d=j.createJSONLoader(),f=j.createModelCompare(),g=j.createModelCloner();try{c=d.loadModelFromString(b).get(0);var h=g.clone(e.getModel());f.merge(h,c).applyOn(h)}catch(b){return console.warn("[main.controller.merge()] Error loading model file"),console.error(b.stack),void l.error({title:"Merge from file",message:"Unable to merge the model with <strong>"+a+"</strong>",delay:15e3})}e.setModel(c,function(b){b?l.error({title:"Merge from file",message:"Unable to merge model <strong>"+a+"</strong><br/>"+b.message,delay:15e3}):l.success({title:"Merge from file",message:"Model merged with <strong>"+a+"</strong>"})})},angular.element("input#file").click()},a.openFromNode=function(a){a.preventDefault(),d.open({templateUrl:"scripts/components/util/host-port-path.modal.html",size:"md",controller:["$scope","$modalInstance",function(a,c){a.title="Open from node",a.action="Open",a.host="127.0.0.1",a.port=9e3,a.path="/",c.rendered.then(function(){b(function(){angular.element("#host").focus()},250)}),a.confirm=function(){a.closeError(),k.getModel(a.host,a.port,a.path,function(d,f,g){d?b(function(){a.error=d.message}):(c.close(),e.setModel(f,function(b){b?l.error({title:a.title,message:"Unable to load model from <strong>"+g+"</strong><br/>"+b.message,delay:15e3}):l.success({title:a.title,message:"Model loaded from <strong>"+g+"</strong>"})}))})},a.closeError=function(){a.error=null}}]})},a.mergeFromNode=function(a){a.preventDefault(),d.open({templateUrl:"scripts/components/util/host-port-path.modal.html",size:"md",controller:["$scope","$modalInstance","kWs",function(a,c,d){a.title="Merge from node",a.action="Merge",a.host="127.0.0.1",a.port=9e3,a.path="/",c.rendered.then(function(){b(function(){angular.element("#host").focus()},250)}),a.confirm=function(){a.closeError(),d.getModel(a.host,a.port,a.path,function(d,f,g){if(d)b(function(){a.error=d.message});else{c.close();var h=j.createModelCompare(),i=j.createModelCloner(),k=i.clone(e.getModel());h.merge(k,f).applyOn(k),e.setModel(f,function(b){b?l.error({title:a.title,message:"Unable to merge model from <strong>"+g+"</strong><br/>"+b.message,delay:15e3}):l.success({title:a.title,message:"Model merged with <strong>"+g+"</strong>"})})}})},a.closeError=function(){a.error=null}}]})},a.disconnectSync=function(){o&&(o.close(),b(function(){a.synced=!1}))},a.connectSync=function(c){if(c.preventDefault(),a.synced)l.warning({title:"Connect sync",message:"You are already synced"});else{var f=a;d.open({templateUrl:"scripts/components/util/host-port-path.modal.html",size:"md",controller:["$scope","$modalInstance",function(a,c){a.title="Connect sync",a.action="Sync",a.host="127.0.0.1",a.port=9e3,a.path="/",c.rendered.then(function(){b(function(){angular.element("#host").focus()},250)}),a.confirm=function(){a.closeError(),a.path?1===a.path.length&&"/"===a.path?a.path="":"/"!==a.path.substr(0,1)&&(a.path="/"+a.path):a.path="",o=new WebSocket("ws://"+a.host+":"+a.port+a.path),o.addEventListener("open",function(){b(function(){f.url=a.host+(80===a.port?"":":"+a.port)+a.path,f.synced=!0}),c.close(),l.success({title:a.title,message:"Connected to <strong>ws://"+a.host+":"+a.port+a.path+"</strong>"})}),o.addEventListener("message",function(b){var c=b.data;"push/"===c.substr(0,"push/".length)&&(c=c.substr("push/".length));var d=j.createJSONLoader();try{var f=d.loadModelFromString(c).get(0);e.setModel(f,function(b){b?l.error({title:a.title,message:"Unable to update synced model from <strong>ws://"+a.host+":"+a.port+a.path+"</strong><br/>"+b.message,delay:15e3}):l.success({title:a.title,message:"Model updated from sync with <strong>ws://"+a.host+":"+a.port+a.path+"</strong>"})})}catch(b){l.error({title:a.title,message:"Error: unable to load received message as a Kevoree JSON model",delay:15e3})}}),o.addEventListener("error",function(){l.error({title:a.title,message:"Error: unable to sync with <strong>ws://"+a.host+":"+a.port+a.path+"</strong>",delay:15e3})}),o.addEventListener("close",function(){b(function(){f.synced=!1}),l.warning({title:a.title,message:"Connection with <strong>ws://"+a.host+":"+a.port+a.path+"</strong> closed"})})},a.closeError=function(){a.error=null}}]})}},a.save=function(a,b){a.preventDefault();var c=j.createJSONSerializer();try{var d=c.serialize(e.getModel());d=JSON.stringify(JSON.parse(d),null,4),g.save(d,b,".json","application/json")}catch(a){l.error({title:"Save",message:"Unable to serialize model to JSON"})}};var p=[];a.copy=function(){p=h.getSelectedPaths().filter(function(a){return"string"==typeof a})},a.paste=function(){p.forEach(function(a){var b=e.getModel(),c=b.findByPath(a);if(c){var d=i.clone(c);switch(i.getTypeDefinitionType(c.typeDefinition)){case"node":b.addNodes(d),c.host&&c.host.addHosts(d);break;case"group":b.addGroups(d);break;case"channel":b.addHubs(d);break;case"component":c.eContainer().addComponents(d)}}}),p.length>0&&e.drawModel()},a.fixOverlapping=function(a){a.preventDefault(),e.fixOverlapping()},a.deleteAll=function(b){b.preventDefault(),a.deleteInstances(b),e.getModel().removeAllPackages()},a.deleteInstances=function(a){a.preventDefault();var b=e.getModel();b.removeAllNodes(),b.removeAllGroups(),b.removeAllHubs(),b.removeAllMBindings(),b.removeAllRepositories()},a.deleteSelection=function(a){a.preventDefault();var b=h.deleteSelected();0===b&&l.warning({title:"Delete selected",message:"Nothing selected"})},a.toggleShortcutHelp=function(){f.toggleCheatSheet()},f.bindTo(a).add({combo:"ctrl+o",description:"Open a model from a file",callback:a.open}),f.bindTo(a).add({combo:"ctrl+m",description:"Merge a model from a file with current model in editor",callback:a.merge}),f.bindTo(a).add({combo:"ctrl+shift+o",description:"Open a model from a node",callback:a.openFromNode}),f.bindTo(a).add({combo:"ctrl+shift+m",description:"Merge a model from a node with current model in editor",callback:a.mergeFromNode}),f.bindTo(a).add({combo:"ctrl+shift+g",description:"Connect to a Web Socket server and stay synced with it",callback:a.connectSync}),f.bindTo(a).add({combo:"ctrl+s",description:"Save the current model into a JSON file",callback:function(c){c.preventDefault();var e=a.save;d.open({templateUrl:"scripts/components/util/filename.modal.html",size:"sm",controller:["$scope","$modalInstance",function(a,d){a.title="Save model",a.body="Would you like to save your current model to a file?",a.filename="model"+(Math.floor(900*Math.random())+100),d.rendered.then(function(){b(function(){angular.element("#filename").focus()},250)}),a.save=function(){function b(a,b){return a.indexOf(b,a.length-b.length)!==-1}var f=".json";b(a.filename,f)&&(a.filename=a.filename.substr(0,a.filename.length-f.length)),e(c,a.filename),d.close()}}]})}}),f.bindTo(a).add({combo:"alt+o",description:"Fix overlapping",callback:a.fixOverlapping}),f.bindTo(a).add({combo:"alt+shift+d",description:"Delete everything in the current model",callback:a.deleteAll}),f.bindTo(a).add({combo:"alt+shift+i",description:"Delete instances in the current model",callback:a.deleteInstances}),f.bindTo(a).add({combo:"del",description:"Delete selected instances in the current model",callback:a.deleteSelection}),f.bindTo(a).add({combo:"ctrl+a",description:"Select all instances",callback:function(a){a.preventDefault(),h.selectAll()}}),f.bindTo(a).add({combo:"ctrl+c",description:"Copy the selected instance(s)",callback:a.copy}),f.bindTo(a).add({combo:"ctrl+v",description:"Paste the selected instance(s)",callback:a.paste}),a.$on("$destroy",function(){n()})}]),angular.module("editorApp").controller("TypedefsCtrl",["$scope","kEditor","ui","kModelHelper","kFactory","kInstance","Notification","KWE_POSITION",function(a,b,c,d,e,f,g,h){function i(){a.packages=[];var c=b.getModel(),e={};c.select("**/typeDefinitions[*]").array.forEach(function(a){var b=d.genPkgName(a.eContainer());e[b]=e[b]||{},e[b].tdefs=e[b].tdefs||{};var c=a.findMetaDataByID("description"),f=c?c.value:"<em>- none -</em>";f.length>=200&&(f=f.substr(0,200)+"...");var g={};a.select("deployUnits[name=*]/filters[name=platform]").array.forEach(function(a){g[a.value]=!0}),e[b].tdefs[a.name]={name:a.name,type:d.getTypeDefinitionType(a),pkgPath:a.eContainer().path(),platforms:Object.keys(g),description:f}}),Object.keys(e).forEach(function(b){var c={name:b,collapsed:!1,tdefs:[]};Object.keys(e[b].tdefs).forEach(function(a){c.tdefs.push(e[b].tdefs[a])}),a.packages.push(c)})}a.packages={},a.dragDraggable={animate:!0,placeholder:"keep",onStart:"onStart",onDrag:"onDrag",onStop:"onStop"},a.dragOptions={revert:"invalid",helper:"clone",addClasses:!1,scroll:!1,appendTo:"#tdef-drag-panel",containment:"#tdef-drag-panel",cursor:"move",cursorAt:{top:-5,right:-5}},a.hasPackages=function(){return Object.keys(a.packages).length>0},a.onStart=function(a,e){if(c.setDropTarget(null),e.helper.hasClass("tdef-item-component")||e.helper.hasClass("tdef-item-node")){var f=document.getElementById("editor-container");this.offset={left:f.offsetLeft,top:f.offsetTop};var g=e.helper[0].dataset.pkgPath,h=e.helper[0].innerHTML.trim(),i=b.getModel().select(g+"/typeDefinitions[name="+h+"]");this.typeDef=d.findBestVersion(i.array)}},a.onDrag=function(a,e){c.mousePos={x:a.clientX,y:a.clientY},(e.helper.hasClass("tdef-item-component")||e.helper.hasClass("tdef-item-node"))&&(clearTimeout(this.timeout),this.hoveredNode&&this.hoveredNode.select(".bg").removeClass("hovered error"),this.timeout=setTimeout(function(){if(this.hoveredNode=c.getHoveredNode(c.mousePos.x-this.offset.left,c.mousePos.y-this.offset.top),this.hoveredNode){var a=this.hoveredNode.select(".bg");a.addClass("hovered"),d.isCompatible(this.typeDef,b.getModel().findByPath(this.hoveredNode.attr("data-path")))?c.setDropTarget(this.hoveredNode):(a.addClass("error"),c.setDropTarget(null))}else c.setDropTarget(null)}.bind(this),100))},a.onStop=function(a,b){(b.helper.hasClass("tdef-item-component")||b.helper.hasClass("tdef-item-node"))&&(clearTimeout(this.timeout),this.hoveredNode?(this.hoveredNode.select(".bg").hasClass("error")&&g.warning({title:"Add component",message:"Targeted node platform cannot run this TypeDefinition",delay:5e3}),this.hoveredNode.select(".bg").removeClass("hovered error")):b.helper.hasClass("tdef-item-component")&&g.warning({title:"Add component",message:"You have to drop components in nodes",delay:5e3}),delete this.typeDef,delete this.timeout,delete this.offset,delete this.hoveredNode)},a.addInstance=function(a){function i(b){b.typeDefinition=a,b.started=!0;var c=e.createValue();c.name=h,c.value=JSON.stringify({x:100,y:100}),b.addMetaData(c),f.initDictionaries(b)}var j=b.getModel().select(a.pkgPath+"/typeDefinitions[name="+a.name+"]");a=d.findBestVersion(j.array);var k,l=d.getTypeDefinitionType(a),m=b.getModel(),n=c.getSelectedNodes();switch(l){case"node":n.length>0?n.forEach(function(a){var b=m.findByPath(a.attr("data-path"));b&&(k=e.createContainerNode(),k.name="node"+parseInt(1e3*Math.random()),i(k),m.addNodes(k),b.addHosts(k))}):(k=e.createContainerNode(),k.name="node"+parseInt(1e3*Math.random()),i(k),m.addNodes(k));break;case"group":k=e.createGroup(),k.name="group"+parseInt(1e3*Math.random()),i(k),m.addGroups(k);break;case"component":n.length>0?n.forEach(function(a){var b=m.findByPath(a.attr("data-path"));b&&(k=e.createComponentInstance(),k.name="comp"+parseInt(1e3*Math.random()),i(k),b.addComponents(k))}):g.warning({title:"Add component",message:"You have to select at least one node",delay:5e3});break;case"channel":k=e.createChannel(),k.name="chan"+parseInt(1e3*Math.random()),i(k),m.addHubs(k)}};var j=b.addModelUpdateListener("tdefs",i,!0),k=b.addNewModelListener("tdefs",i);i(),a.$on("$destroy",function(){j(),k()})}]),angular.module("editorApp").controller("EditorCtrl",["$scope","kEditor","ui","uiUtils","kModelHelper","kFactory","kInstance","hotkeys","Notification","KWE_POSITION","KWE_FOLDED",function(a,b,c,d,e,f,g,h,i,j,k){function l(a,d){return function(){var e=c.getSelectedPaths();e&&e.forEach(function(c){if(c){var e=b.getModel().findByPath(c);if(e&&"function"==typeof e.findMetaDataByID){var f=e.findMetaDataByID(j);if(f){var g=JSON.parse(f.value);switch(a){case"up":g.y-=d;break;case"right":g.x+=d;break;case"down":g.y+=d;break;case"left":g.x-=d}f.value=JSON.stringify(g)}}}})}}c.init(),b.drawModel(),a.dropDroppable={onDrop:"onDrop"},a.dropOptions={accept:function(a){var d=!1,f=a[0].dataset.pkgPath,g=a[0].innerHTML.trim(),h=b.getModel().select(f+"/typeDefinitions[name="+g+"]"),i=e.findBestVersion(h.array),j=e.getTypeDefinitionType(i);return d="component"!==j||c.getDropTarget()}},a.onDrop=function(a,h){function k(a){a.typeDefinition=q,a.started=!0;var b=f.createValue();b.name=j;var e=d.getPointInEditor(c.mousePos.x,c.mousePos.y);b.value=JSON.stringify({x:e.x-s.e,y:e.y-s.f}),a.addMetaData(b),g.initDictionaries(a)}var l,m,n=h.draggable.scope().tdef.pkgPath,o=h.draggable.scope().tdef.name,p=b.getModel().select(n+"/typeDefinitions[name="+o+"]"),q=e.findBestVersion(p.array),r=e.getTypeDefinitionType(q),s=c.editor.transform().localMatrix,t=b.getModel(),u=c.getDropTarget();switch(r){case"node":l=f.createContainerNode(),l.name="node"+parseInt(1e3*Math.random()),k(l),t.addNodes(l),u&&(m=t.findByPath(u.attr("data-path")),m&&m.addHosts(l));break;case"group":l=f.createGroup(),l.name="group"+parseInt(1e3*Math.random()),k(l),g.initFragmentDictionaries(l),t.addGroups(l);break;case"component":l=f.createComponentInstance(),l.name="comp"+parseInt(1e3*Math.random()),k(l),u?(m=t.findByPath(u.attr("data-path")),m&&m.addComponents(l)):i.warning({title:"Add component",message:"You have to drop components in nodes",delay:5e3});break;case"channel":l=f.createChannel(),l.name="chan"+parseInt(1e3*Math.random()),k(l),g.initFragmentDictionaries(l),t.addHubs(l)}return c.setDropTarget(null),!0},h.bindTo(a).add({combo:"f",description:"Fold/Unfold selected node",callback:function(){var a=c.getSelectedPaths();a&&a.forEach(function(a){if(a){var c=b.getModel().findByPath(a);if("node"===e.getTypeDefinitionType(c.typeDefinition)){var d=c.findMetaDataByID(k);if(d){var g=e.isTruish(d.value);d.value=!g}else d=f.createValue(),d.name=k,d.value=!0,c.addMetaData(d)}}})}}),h.bindTo(a).add({combo:"up",description:"Move the selected instances 1 pixel up",callback:l("up",1)}),h.bindTo(a).add({combo:"ctrl+up",description:"Move the selected instances 15 pixel up",callback:l("up",15)}),h.bindTo(a).add({combo:"right",description:"Move the selected instances 1 pixel right",callback:l("right",1)}),h.bindTo(a).add({combo:"ctrl+right",description:"Move the selected instances 15 pixel right",callback:l("right",15)}),h.bindTo(a).add({combo:"down",description:"Move the selected instances 1 pixel down",callback:l("down",1)}),h.bindTo(a).add({combo:"ctrl+down",description:"Move the selected instances 15 pixel down",callback:l("down",15)}),h.bindTo(a).add({combo:"left",description:"Move the selected instances 1 pixel left",callback:l("left",1)}),h.bindTo(a).add({combo:"ctrl+left",description:"Move the selected instances 15 pixel left",callback:l("left",15)})}]),angular.module("editorApp").controller("SelectChanModalCtrl",["$scope","$modalInstance","startPort","endPort","orderByFilter","kInstance","kEditor","kFactory","kModelHelper","KWE_POSITION",function(a,b,c,d,e,f,g,h,i,j){var k;a.instances=e(g.getModel().hubs.array.filter(function(a){return a.selected=!1,!i.isAlreadyBound(d,a)&&!i.isAlreadyBound(c,a)&&i.isCompatible(a.typeDefinition,c.eContainer().eContainer())&&i.isCompatible(a.typeDefinition,d.eContainer().eContainer())}),"typeDefinition.name"),a.types=e(i.getChannelTypes(g.getModel()).filter(function(a){return a.selected=!1,i.isCompatible(a,c.eContainer().eContainer())&&i.isCompatible(a,d.eContainer().eContainer())}),"name"),a.types.length>0&&(a.types[0].selected=!0,k=a.types[0]),a.isValid=function(){for(var b=0;b<a.instances.length;b++)if(a.instances[b].selected)return!0;for(b=0;b<a.types.length;b++)if(a.types[b].selected)return!0;return!1},a.select=function(b){b.selected||(a.instances.forEach(function(a){b.path()!==a.path()&&a.selected&&(a.selected=!1)}),a.types.forEach(function(a){b.path()!==a.path()&&a.selected&&(a.selected=!1)}),b.selected=!b.selected,k=b)},a.confirm=function(){var a;if("typeDefinitions"===k.getRefInParent()){a=h.createChannel(),a.name="chan"+parseInt(1e3*Math.random()),a.typeDefinition=k,a.started=!0;var c=h.createValue();c.name=j,c.value=JSON.stringify({x:100,y:100}),a.addMetaData(c),f.initDictionaries(a),g.getModel().addHubs(a)}else a=k;b.close(a)}}]),angular.module("editorApp").controller("InstanceCtrl",["$scope","$timeout","$modal","hotkeys","ui","kEditor","kFactory","kInstance","kModelHelper",function(a,b,c,d,e,f,g,h,i){function j(){a.versions=a.instance.typeDefinition.eContainer().select("typeDefinitions[name="+a.instance.typeDefinition.name+"]").array.map(function(a){return a.version}),a.instance.selectedVersion=a.instance.typeDefinition.version;var b=a.instance.typeDefinition.findMetaDataByID("description");b?a.description=b.value:a.description="<em>- none -</em>",a.instance.typeDefinition.dictionaryType?(a.dicAttrs=a.instance.typeDefinition.dictionaryType.select("attributes[fragmentDependant=false]").array,a.fragDicAttrs=a.instance.typeDefinition.dictionaryType.select("attributes[fragmentDependant=true]").array):(a.dicAttrs=[],a.fragDicAttrs=[]),h.initDictionaries(a.instance)}function k(b,c,d){c&&b.values.array.forEach(function(b){var e=c.select("attributes[name="+b.name+"]").array[0];e?a.isTruish(e.fragmentDependant)?d||b.delete():d&&b.delete():b.delete()})}function l(){b(function(){a.instance=null,a.type=null,a.versions=[],a.description="<em>- none -</em>",a.dicAttrs=[],a.fragDicAttrs=[],a.processing=!0;var b=i.getSelection(f.getModel());1===b.length&&(a.instance=b[0],a.instance&&(a.instance.selectedVersion=a.instance.typeDefinition.version,angular.element(".ui-notification").css("right","260px"),a.instance.preName=a.instance.name,a.type=i.getTypeDefinitionType(a.instance.typeDefinition),j(),a.processing=!1))})}var m;a.instance=null,a.type=null,a.mainCollapsed=!1,a.dicCollapsed=!1,a.netCollapsed=!1,a.descCollapsed=!1,a.fragCollapsed={},a.changeName=function(b,c){b.name.$valid&&(a.instance.name=c)},a.changeVersion=function(b){b&&(a.instance.typeDefinition=a.instance.typeDefinition.eContainer().select("**/typeDefinitions[name="+a.instance.typeDefinition.name+",version="+b+"]").array[0],k(a.instance.dictionary,a.instance.typeDefinition.dictionaryType,!1),a.instance.fragmentDictionary.array.forEach(function(b){k(b,a.instance.typeDefinition.dictionaryType,!0)}),j())},a.hasFragmentDictionary=function(){return!(!a.instance||!a.instance.fragmentDictionary)&&a.instance.fragmentDictionary.size()>0},a.hasNetworkInformation=function(){return a.instance&&"undefined"!=typeof a.instance.networkInformation},a.manageNetwork=function(b,d){b.stopPropagation(),c.open({templateUrl:"scripts/app/main/instance/network.modal.html",size:"md",resolve:{node:function(){return a.instance},net:function(){return d}},controller:"InstanceNetworkModalCtrl"})},a.addNetwork=function(){var b=g.createNetworkInfo();b.name="net"+a.instance.networkInformation.size(),c.open({templateUrl:"scripts/app/main/instance/network.modal.html",size:"md",resolve:{node:function(){return a.instance},net:function(){return b}},controller:"InstanceNetworkModalCtrl"})},a.openGroupModal=function(){c.open({templateUrl:"scripts/app/main/instance/group.modal.html",size:"md",resolve:{group:function(){return a.instance}},controller:"GroupModalCtrl"})},a.isTruish=i.isTruish,a.isReadOnly=function(){if(a.instance){var b=a.instance.findMetaDataByID("access_mode");return b&&"read-only"===b.value}return!1},a.isVirtual=function(){return i.isVirtual(a.instance)},l();var n=f.addModelUpdateListener("selected",l,!0),o=f.addNewModelListener("selected",l);a.$on("$destroy",function(){n(),o(),b.cancel(m)})}]),angular.module("editorApp").controller("InstanceNetworkModalCtrl",["$scope","$modalInstance","$timeout","node","net","kFactory",function(a,b,c,d,e,f){a.node=d,a.net=e,a.newVal={name:null,value:null},a.addNewVal=function(){if(a.newVal.name&&a.newVal.value){var b=f.createValue();b.name=a.newVal.name,b.value=a.newVal.value,a.net.addValues(b),a.newVal.name=null,a.newVal.value=null,angular.element("input#newValName").focus()}},a.add=function(){d.addNetworkInformation(a.net),b.close()},a.delete=function(){a.net.delete(),b.close()},a.canSave=function(){return e.values.array.length>0}}]),angular.module("editorApp").factory("groupModalHolder",function(){return{host:"127.0.0.1",port:"9000",path:"/"}}).controller("GroupModalCtrl",["$scope","$modalInstance","$timeout","group","kEditor","kWs","groupModalHolder",function(a,b,c,d,e,f,g){if(a.type="push to",a.action="push",a.group=d,a.selectedHost=g.host,a.selectedPort=g.port,a.selectedPath=g.path,a.processing=!1,a.modelHasErrors=e.modelHasErrors(),a.hosts={"127.0.0.1":"default"},a.ports={9000:"default"},a.paths={"/":"default"},a.changeHost=function(){g.host=a.selectedHost},a.changePort=function(){g.port=a.selectedPort},a.changePath=function(){g.path=a.selectedPath},d.dictionary){var h=d.dictionary.findValuesByID("host");h&&!a.hosts[h.value]&&(a.hosts[h.value]=d.name);var i=d.dictionary.findValuesByID("port");i&&!a.ports[i.value]&&(a.ports[i.value]=d.name);var j=d.dictionary.findValuesByID("path");j&&!a.paths[j.value]&&(a.paths[j.value]=d.name)}d.subNodes.array.forEach(function(b){var c=d.findFragmentDictionaryByID(b.name);if(c){var e=c.findValuesByID("port"),f=c.findValuesByID("path");e&&!a.ports[e.value]&&(a.ports[e.value]=b.name),f&&!a.paths[f.value]&&(a.paths[f.value]=b.name)}b.networkInformation.array.forEach(function(c){c.values.array.forEach(function(c){a.hosts[c.value]||(a.hosts[c.value]=b.name)})})}),a.closeError=function(){a.error=null},a.closeModelHasErrorsWarning=function(){a.modelHasErrors=null},a.closeSuccess=function(){a.success=null};var k;a.push=function(){a.action="pushed to",a.error=null,a.processing=!0,c(function(){k=f.pushModel(e.getModel(),a.selectedHost,a.selectedPort,a.selectedPath,function(b){c(function(){b?(a.processing=!1,a.error=b.message):(a.processing=!1,a.success=!0)})})})},a.pull=function(){a.action="pulled from",a.error=null,a.processing=!0,k=f.getModel(a.selectedHost,a.selectedPort,a.selectedPath,function(b,d){c(function(){b?(a.processing=!1,a.error=b.message):(a.processing=!1,a.success=!0,e.setModel(d))})})},a.close=function(){k&&k.close(),b.close()}}]),angular.module("editorApp").controller("NavBarCtrl",["$scope","$state",function(a,b){a.isCollapsed=!0,a.$state=b}]),angular.module("editorApp").config(["$stateProvider",function(a){a.state("settings",{parent:"app",url:"/settings",views:{"content@":{templateUrl:"scripts/app/settings/settings.html",controller:"SettingsCtrl"}}})}]),angular.module("editorApp").controller("SettingsCtrl",["$scope","kScript","kRegistry","storage","Notification",function(a,b,c,d,e){a.registryUrl=c.getUrl(),a.getUrl=function(){return c.getUrl()},a.changeKevoreeRegistry=function(){if(a.registryUrl!==c.getUrl().toString())try{var b=new URL(a.registryUrl);c.setUrl(b),e.success({title:"Kevoree Registry",message:"URL successfully updated",delay:3e3})}catch(b){e.error({title:"Kevoree Registry",message:"Invalid URL "+a.registryUrl,delay:3e3})}},a.canChangeKevoreeRegistry=function(){return void 0!==a.registryUrl&&null!==a.registryUrl&&a.registryUrl!==c.getUrl().toString()}}]),angular.module("editorApp").config(["$stateProvider",function(a){a.state("kevscript",{parent:"app",url:"/kevscript",views:{"content@":{templateUrl:"scripts/app/kevscript/kevscript.html",controller:"KevScriptCtrl"}}})}]),angular.module("editorApp").controller("KevScriptCtrl",["$rootScope","$scope","$modal","$timeout","$state","hotkeys","kEditor","kScript","saveFile","storage","Notification",function(a,b,c,d,e,f,g,h,i,j,k){function l(a){a&&(console.log(a),a.preventDefault()),c.open({templateUrl:"scripts/components/util/filename.modal.html",size:"sm",scope:b,controller:["$scope","$modalInstance",function(a,b){a.title="Save Kevscript",a.body="Would you like to save your current KevScript to a file?",a.filename="script"+(Math.floor(900*Math.random())+100),a.save=function(){function c(a,b){return a.indexOf(b,a.length-b.length)!==-1}var d=".kevs";c(a.filename,d)&&(a.filename=a.filename.substr(0,a.filename.length-".kevs".length)),i.save(a.kevscript,a.filename,d,"kevscript"),b.close()}}]}).result.finally(function(){n&&n.focus()})}function m(a){a&&a.preventDefault(),angular.element("input#kevscript-upload").click()}var n=null;b.kevscript="",b.processing=!1,b.message=null,b.ctxVars={},b.error=null,b.lintWarnings=[],b.linting=!1,b.typing=!1,b.editorState="idle",b.editorOptions={mode:"kevscript",theme:"kevscript",lineWrapping:!0,lineNumbers:!0,styleActiveLine:!0,extraKeys:{Tab:!1,"Ctrl-Space":"autocomplete","Ctrl-S":function(){l()},"Ctrl-O":function(){m()}},gutters:["CodeMirror-lint-markers"],lint:{getAnnotations:CodeMirror.lint.kevscript(b.ctxVars),async:!0}},b.dndLoad=function(c,d){c.endsWith(".kevs")?b.kevscript=d:(b.kevscript="",a.dndLoad(c,d))},b.editorLoaded=function(a){n=a,n.on("beforeChange",function(){d(function(){b.editorState="typing",b.error=null,b.lintWarnings=[]})}),n.on("lintStart",function(){d(function(){b.editorState="linting"})}),n.on("lintDone",function(a,c,e){d(function(){b.editorState="idle",b.model=e,b.error=a||c.filter(function(a){return"error"===a.severity})[0],b.lintWarnings=c.filter(function(a){return"warning"===a.severity}),b.linting=!1})}),n.focus(),CodeMirror.signal(n,"change",n)},b.uploadKevscript=function(){var a=angular.element("#kevscript-upload");a.on("change",function(a){var c=new FileReader;c.onloadend=function(){b.kevscript=n.setValue(c.result)},c.readAsBinaryString(a.target.files[0])}),a.trigger("click")},b.closeMessage=function(){b.message=null},b.isMergeable=function(){return"idle"===b.editorState&&!b.processing&&!b.error&&b.kevscript.trim().length>0},b.clearCtxVars=function(){Object.keys(b.ctxVars).forEach(function(a){delete b.ctxVars[a]}),CodeMirror.signal(n,"change",n)},b.addCtxVar=function(a){a.key&&a.value&&(b.ctxVars[a.key]=a.value,a.key="",a.value="",CodeMirror.signal(n,"change",n))},b.onFileLoaded=function(a,c){b.kevscript=c},b.removeCtxVar=function(a){delete b.ctxVars[a],CodeMirror.signal(n,"change",n)},b.merge=function(){b.processing||(b.processing=!0,d(function(){g.setModel(b.model,function(a){b.processing=!1,a?b.error=a:(n.setValue(""),k.success({title:"KevScript",message:"Successfully merged"}))})}))},b.model2kevs=function(){try{var a=h.parseModel(g.getModel());n.setValue(a)}catch(a){console.warn("[kevscript.controller.model2kevs()] Error creating Kevscript from model"),console.error(a.stack),k.error({title:"KevScript parser",message:"Unable to convert current model to KevScript",delay:5e3})}},b.save=l,b.open=m,f.bindTo(b).add({combo:"ctrl+o",description:"Open a KevScript from a file",callback:b.open}),f.bindTo(b).add({combo:"ctrl+s",description:"Save current KevScript to a file",callback:b.save}),b.toggleShortcutHelp=function(){f.toggleCheatSheet()}}]),angular.module("editorApp").config(["$stateProvider",function(a){a.state("libraries",{parent:"app",url:"/libs/{fqn}",views:{"content@":{templateUrl:"scripts/app/libraries/libraries.html",controller:"LibrariesCtrl"}}})}]),angular.module("editorApp").controller("LibrariesCtrl",["$scope","$timeout","kRegistry","kModelHelper","kFactory","kEditor",function(a,b,c,d,e,f){function g(b,c){function d(a){var c=e.createModelCompare();a.forEach(function(a){c.merge(h,a.model).applyOn(h);var d=g.path()+"/deployUnits[name="+a.name+",version="+a.version+"]";h.select(d).array.forEach(function(a){b.selectedVersion.model.addDeployUnits(a)})})}var f=a.getTdefInModel(b);f&&(f.deployUnits.array.forEach(function(a){a.delete()}),f.removeAllDeployUnits());var g,h=e.createContainerRoot().withGenerated_KMF_ID(0);e.root(h);var i;return b.namespace.name.split(".").forEach(function(a,b,c){var d=e.createPackage();d.name=a,i?i.addPackages(d):h.addPackages(d),i=d,b+1===c.length&&(g=i)}),g.addTypeDefinitions(b.selectedVersion.model),d(c?b.selectedVersion.releaseDus:b.selectedVersion.latestDus),h}a.loading=!0,a.groups=[],a.nodes=[],a.channels=[],a.components=[],a.tdefSearch={name:"",namespace:"",platform:""},a.selection=[],a.getUrl=function(){var a=c.getUrl().toString();return a.endsWith("/")?a.substr(0,a.length-1):a},c.getAll().then(function(c){
b(function(){c.forEach(function(b){"org.kevoree.GroupType"===b.type?a.groups.push(b):"org.kevoree.NodeType"===b.type?a.nodes.push(b):"org.kevoree.ChannelType"===b.type?a.channels.push(b):"org.kevoree.ComponentType"===b.type&&a.components.push(b)}),a.loading=!1})}).catch(function(c){b(function(){c.status>=300?a.error=c.config.method+" "+c.config.url+" failed ("+c.status+" "+c.statusText+")":a.error="Unable to reach "+a.getUrl(),a.loading=!1})}),a.select=function(d,e){d.preventDefault(),angular.isDefined(e.open)||(e.open=!0);var f=Boolean(e.selected),g=a.selection.length;d.ctrlKey?f?e.selected=!1:e.selected=!0:(a.selection.length=0,a.groups.concat(a.nodes).concat(a.channels).concat(a.components).forEach(function(a){a.selected=!1}),f&&g>1?e.selected=!0:e.selected=!f),e.selected?a.selection.indexOf(e)===-1&&(e.selectedVersion=e.versions[e.versions.length-1],a.selection.push(e),c.addDeployUnits(e.namespace.name,e.name,e.selectedVersion.version).then(function(a){b(function(){e.selectedVersion.latestDus=a.latestDus,e.selectedVersion.releaseDus=a.releaseDus})})):a.selection.splice(a.selection.indexOf(e),1)},a.getTdefInModel=function(a){var b=f.getModel(),c=d.pkgFqnToPath(a.namespace.name),e="/"+c+"/typeDefinitions[name="+a.name+",version="+a.selectedVersion.version+"]";return b.findByPath(e)},a.changeVersion=function(b){c.addDeployUnits(b.namespace.name,b.name,b.selectedVersion.version,b.selectedVersion),a.closeError()},a.useLatest=function(b){try{f.merge(g(b,!1)),a.success=!0}catch(b){a.error=b.message}},a.useReleases=function(b){try{f.merge(g(b,!0)),a.success=!0}catch(b){a.error=b.message}},a.useAllLatest=function(){a.selection.forEach(function(b){a.isAlreadyInModel(b,!1)||a.useLatest(b)})},a.useAllReleases=function(){a.selection.forEach(function(b){a.isAlreadyInModel(b,!0)||a.useReleases(b)})},a.isAlreadyInModel=function(b,c){var d=a.getTdefInModel(b);if(d){var e;e=c?b.selectedVersion.releaseDus||[]:b.selectedVersion.latestDus||[];for(var f=0;f<e.length;f++){var g="deployUnits[name="+e[f].name+",version="+e[f].version+"]";if(1!==d.eContainer().select(g).array.length)return!1}}return d},a.areAlreadyInModel=function(b){return a.selection.every(function(c){return a.isAlreadyInModel(c,b)})},a.hasReleases=function(){return a.selection.some(function(a){return a.selectedVersion.releaseDus&&a.selectedVersion.releaseDus.length})},a.hasLatest=function(){return a.selection.some(function(a){return a.selectedVersion.latestDus&&a.selectedVersion.latestDus.length})},a.closeError=function(){a.error=null}}]),angular.module("editorApp").config(["$stateProvider",function(a){a.state("treeview",{parent:"app",url:"/treeview",views:{"content@":{templateUrl:"scripts/app/treeview/treeview.html",controller:"TreeViewCtrl"}},onExit:["kEditor",function(a){a.removeModelUpdateListeners("treeview")}]})}]),angular.module("editorApp").controller("TreeViewCtrl",["$scope","$timeout","$filter","$modal","kEditor","kModelHelper","kFactory","kWs","kFilterParser","saveFile","hotkeys","Notification",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(b){a.nbInstances+=1;var c={name:b.name,kevsName:b.eContainer().name+"."+b.name,type:"component",typeName:b.typeDefinition.name,version:b.typeDefinition.version,tags:f.getTags(b),path:b.path(),selected:f.isSelected(b)};return c.selected&&a.selectedItems.push(c),c}function n(b){a.nbInstances+=1;var c={name:b.name,type:"node",typeName:b.typeDefinition.name,version:b.typeDefinition.version,tags:f.getTags(b),path:b.path(),folded:f.isFolded(b),selected:f.isSelected(b),children:b.components.array.map(m)};return c.selected&&a.selectedItems.push(c),c}function o(b){a.nbInstances+=1;var c={name:b.name,type:"group",typeName:b.typeDefinition.name,version:b.typeDefinition.version,tags:f.getTags(b),path:b.path(),selected:f.isSelected(b)};return c.selected&&a.selectedItems.push(c),c}function p(b){a.nbInstances+=1;var c={name:b.name,type:"channel",typeName:b.typeDefinition.name,version:b.typeDefinition.version,tags:f.getTags(b),path:b.path(),selected:f.isSelected(b)};return c.selected&&a.selectedItems.push(c),c}function q(a){return a.nodes.array.map(n).concat(a.groups.array.map(o)).concat(a.hubs.array.map(p))}function r(b){for(var c=0;c<a.items.length;c++)if(a.items[c].path===b)return void(a.items[c].folded&&(a.items[c].folded=!1,f.setFolded(e.getModel().findByPath(a.items[c].path),!1)))}function s(){a.nbInstances=0,a.selectedItems=[],a.items=q(e.getModel())}function t(a){x=a.ctrlKey}function u(a){x=a.ctrlKey}function v(b){x||a.clearSelected(),a.items.forEach(function(c){c.type===b&&(c.selected=!0,a.selectedItems.push(c),f.setSelected(e.getModel().findByPath(c.path),!0))})}a.items=[],a.limit=30,a.nbInstances=0,a.showTags=!0,a.selectedItems=[],a.filterExpr="",a.filterComparator=!1,a.treeReverse=!1,a.query=null;var w=e.addNewModelListener("treeview",s);s();var x=!1;document.addEventListener("keydown",t),document.addEventListener("keyup",u),a.loadMore=function(){a.items.length>a.limit&&(a.limit+=10)},a.onClick=function(b){var c=b.selected;x||(c&&a.selectedItems.length>1&&a.selectedItems.indexOf(b)!==-1&&(c=!c),a.selectedItems.forEach(function(a){f.setSelected(e.getModel().findByPath(a.path),!1),a.selected=!1}),a.selectedItems.length=0),f.setSelected(e.getModel().findByPath(b.path),!c),b.selected=!c,b.selected?a.selectedItems.push(b):a.selectedItems.splice(a.selectedItems.indexOf(b),1)},a.onExpand=function(a){a.folded=!a.folded,f.setFolded(e.getModel().findByPath(a.path),a.folded)},a.collapse=function(){a.items.forEach(function(a){"node"===a.type&&(a.folded=!0,f.setFolded(e.getModel().findByPath(a.path),!0))})},a.expand=function(){a.items.forEach(function(a){"node"===a.type&&(a.folded=!1,f.setFolded(e.getModel().findByPath(a.path),!1))})},a.selectAll=function(){a.selectedItems.length=0,a.items.forEach(function(b){b.selected=!0;var c=e.getModel().findByPath(b.path);f.setSelected(c,!0),a.selectedItems.push(b),b.children&&b.children.forEach(function(d){d.selected=!0,b.folded=!1,f.setFolded(c,!1),f.setSelected(e.getModel().findByPath(d.path),!0),a.selectedItems.push(d)})})},a.selectNodes=function(){v("node")},a.selectGroups=function(){v("group")},a.selectChannels=function(){v("channel")},a.selectComponents=function(){x||a.clearSelected(),a.items.forEach(function(b){"node"===b.type&&b.children&&b.children.forEach(function(c){b.folded=!1,c.selected=!0,f.setFolded(e.getModel().findByPath(b.path),!1),f.setSelected(e.getModel().findByPath(c.path),!0),a.selectedItems.push(c)})})},a.selectByTag=function(b){x||a.clearSelected(),b.forEach(function(b){b.selected=!0,a.selectedItems.push(b);var c=e.getModel().findByPath(b.path);f.setSelected(c,!0),"component"===b.type&&r(c.eContainer().path())})},a.clearSelected=function(){a.selectedItems.forEach(function a(b){b.selected=!1,f.setSelected(e.getModel().findByPath(b.path),!1),b.children&&b.children.forEach(a)}),a.selectedItems.length=0},a.toggleTags=function(){a.showTags=!a.showTags},a.reverseSort=function(){a.treeReverse=!a.treeReverse},a.createItem=function(b,c,d){switch(b){case"node":a.items.push(n(c));break;case"group":a.items.push(o(c));break;case"channel":a.items.push(p(c));break;case"component":for(var e=0;e<a.items.length;e++)if(a.items[e].path===d.path()){a.items[e].children.push(m(c));break}}},a.clearFilter=function(){a.query=null,a.filterExpr="",a.filterError=null};var y;a.onFilterExprChanged=function(){b.cancel(y),y=b(function(){a.parseFilterExpr()},300)},a.parseFilterExpr=function(){if(0===a.filterExpr.length)a.query=null,a.filterError=null;else try{a.query=i.parse(a.filterExpr),a.filterError=null}catch(b){a.query=null,a.filterError=b.name+': "'+b.found+'" at col.'+b.location.start.column}},a.open=function(c){c.preventDefault(),a.onFileLoaded=function(c,d){b(function(){a.loading=!0,b(function(){var b=e.getModel();try{var f=g.createJSONLoader(),h=f.loadModelFromString(d).get(0);e.setModel(h),l.success({title:"Open from file",message:"Model loaded from <strong>"+c+"</strong>"})}catch(a){console.warn("[main.controller.open()] Error loading model file"),console.error(a.stack),l.error({title:"Open from file",message:"Unable to load a model from <strong>"+c+"</strong>"}),e.setModel(b)}finally{a.loading=!1}})})},angular.element("input#file").click()},a.merge=function(c){c.preventDefault(),a.onFileLoaded=function(c,d){b(function(){a.loading=!0,b(function(){try{var b=g.createJSONLoader(),f=g.createModelCompare(),h=b.loadModelFromString(d).get(0);f.merge(h,e.getModel()).applyOn(h),e.setModel(h),l.success({title:"Merge from file",message:"Model merged with <strong>"+c+"</strong>"})}catch(a){console.warn("[main.controller.merge()] Error loading model file"),console.error(a.stack),l.error({title:"Merge from file",message:"Unable to merge the model with <strong>"+c+"</strong>"})}finally{a.loading=!1}})})},angular.element("input#file").click()},a.openFromNode=function(a){a.preventDefault(),d.open({templateUrl:"scripts/components/util/host-port-path.modal.html",size:"md",controller:["$scope","$modalInstance",function(a,c){a.title="Open from node",a.action="Open",a.host="127.0.0.1",a.port=9e3,a.path="/",c.rendered.then(function(){b(function(){angular.element("#host").focus()},250)}),a.confirm=function(){a.closeError(),h.getModel(a.host,a.port,a.path,function(d,f,g){d?b(function(){a.error=d.message}):(e.setModel(f),l.success({title:a.title,message:"Model loaded from <strong>"+g+"</strong>"}),c.close())})},a.closeError=function(){a.error=null}}]})},a.mergeFromNode=function(a){a.preventDefault(),d.open({templateUrl:"scripts/components/util/host-port-path.modal.html",size:"md",controller:["$scope","$modalInstance","kWs",function(a,c,d){a.title="Merge from node",a.action="Merge",a.host="127.0.0.1",a.port=9e3,a.path="/",c.rendered.then(function(){b(function(){angular.element("#host").focus()},250)}),a.confirm=function(){a.closeError(),d.getModel(a.host,a.port,a.path,function(d,f,h){if(d)b(function(){a.error=d.message});else{var i=g.createModelCompare();i.merge(f,e.getModel()).applyOn(f),e.setModel(f),l.success({title:a.title,message:"Model merged with <strong>"+h+"</strong>"}),c.close()}})},a.closeError=function(){a.error=null}}]})},a.save=function(a,b){a.preventDefault();var c=g.createJSONSerializer();try{var d=c.serialize(e.getModel());d=JSON.stringify(JSON.parse(d),null,4),j.save(d,b,".json","application/json")}catch(a){l.error({title:"Save",message:"Unable to serialize model to JSON"})}},a.deleteAll=function(b){b.preventDefault(),a.deleteInstances(b),e.getModel().removeAllPackages()},a.deleteInstances=function(a){a.preventDefault();var b=e.getModel();b.removeAllNodes(),b.removeAllGroups(),b.removeAllHubs(),b.removeAllMBindings(),b.removeAllRepositories(),s()},a.deleteSelection=function(a){a.preventDefault();var b=f.getSelection(e.getModel());0===b.length?l.warning({title:"Delete selection",message:"Nothing selected"}):(b.forEach(function(a){a.delete()}),s())},a.toggleShortcutHelp=function(){k.toggleCheatSheet()},k.bindTo(a).add({combo:"ctrl+o",description:"Open a model from a file",callback:a.open}),k.bindTo(a).add({combo:"ctrl+m",description:"Merge a model from a file with current model in editor",callback:a.merge}),k.bindTo(a).add({combo:"ctrl+shift+o",description:"Open a model from a node",callback:a.openFromNode}),k.bindTo(a).add({combo:"ctrl+shift+m",description:"Merge a model from a node with current model in editor",callback:a.mergeFromNode}),k.bindTo(a).add({combo:"ctrl+shift+g",description:"Connect to a Web Socket server and stay synced with it",callback:a.connectSync}),k.bindTo(a).add({combo:"ctrl+s",description:"Save the current model into a JSON file",callback:function(c){c.preventDefault();var e=a.save;d.open({templateUrl:"scripts/components/util/filename.modal.html",size:"sm",controller:["$scope","$modalInstance",function(a,d){a.title="Save model",a.body="Would you like to save your current model to a file?",a.filename="model"+(Math.floor(900*Math.random())+100),d.rendered.then(function(){b(function(){angular.element("#filename").focus()},250)}),a.save=function(){function b(a,b){return a.indexOf(b,a.length-b.length)!==-1}var f=".json";b(a.filename,f)&&(a.filename=a.filename.substr(0,a.filename.length-f.length)),e(c,a.filename),d.close()}}]})}}),k.bindTo(a).add({combo:"alt+shift+d",description:"Delete everything in the current model",callback:a.deleteAll}),k.bindTo(a).add({combo:"alt+shift+i",description:"Delete instances in the current model",callback:a.deleteInstances}),k.bindTo(a).add({combo:"del",description:"Delete selected instances in the current model",callback:a.deleteSelection}),k.bindTo(a).add({combo:"ctrl+a",description:"Select all instances",callback:function(b){b.preventDefault(),a.selectAll()}}),a.$on("$destroy",function(){w(),document.removeEventListener("keydown",t),document.removeEventListener("keyup",u),b.cancel(y)})}]),angular.module("editorApp").factory("kFilterParser",function(){function a(a,b){function c(){this.constructor=a}c.prototype=b.prototype,a.prototype=new c}function b(a,c,d,e){this.message=a,this.expected=c,this.found=d,this.location=e,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,b)}function c(a){function c(){return a.substring(db,cb)}function d(b){throw h(b,null,a.substring(db,cb),f(db,cb))}function e(b){var c,d,e=eb[b];if(e)return e;for(c=b-1;!eb[c];)c--;for(e=eb[c],e={line:e.line,column:e.column,seenCR:e.seenCR};c<b;)d=a.charAt(c),"\n"===d?(e.seenCR||e.line++,e.column=1,e.seenCR=!1):"\r"===d||"\u2028"===d||"\u2029"===d?(e.line++,e.column=1,e.seenCR=!0):(e.column++,e.seenCR=!1),c++;return eb[b]=e,e}function f(a,b){var c=e(a),d=e(b);return{start:{offset:a,line:c.line,column:c.column},end:{offset:b,line:d.line,column:d.column}}}function g(a){cb<fb||(cb>fb&&(fb=cb,gb=[]),gb.push(a))}function h(a,c,d,e){function f(a){var b=1;for(a.sort(function(a,b){return a.description<b.description?-1:a.description>b.description?1:0});b<a.length;)a[b-1]===a[b]?a.splice(b,1):b++}function g(a,b){function c(a){function b(a){return a.charCodeAt(0).toString(16).toUpperCase()}return a.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(a){return"\\x0"+b(a)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(a){return"\\x"+b(a)}).replace(/[\u0100-\u0FFF]/g,function(a){return"\\u0"+b(a)}).replace(/[\u1000-\uFFFF]/g,function(a){return"\\u"+b(a)})}var d,e,f,g=new Array(a.length);for(f=0;f<a.length;f++)g[f]=a[f].description;return d=a.length>1?g.slice(0,-1).join(", ")+" or "+g[a.length-1]:g[0],e=b?'"'+c(b)+'"':"end of input","Expected "+d+" but "+e+" found."}return null!==c&&f(c),new b(null!==a?a:g(c,d),c,d,e)}function i(){var b,c,d,e,f,h,i,k;if(b=cb,c=j(),c!==G){for(d=[],e=cb,f=D(),f!==G?(124===a.charCodeAt(cb)?(h=J,cb++):(h=G,0===hb&&g(K)),h!==G?(i=D(),i!==G?(k=j(),k!==G?(f=[f,h,i,k],e=f):(cb=e,e=G)):(cb=e,e=G)):(cb=e,e=G)):(cb=e,e=G);e!==G;)d.push(e),e=cb,f=D(),f!==G?(124===a.charCodeAt(cb)?(h=J,cb++):(h=G,0===hb&&g(K)),h!==G?(i=D(),i!==G?(k=j(),k!==G?(f=[f,h,i,k],e=f):(cb=e,e=G)):(cb=e,e=G)):(cb=e,e=G)):(cb=e,e=G);d!==G?(db=b,c=L(c,d),b=c):(cb=b,b=G)}else cb=b,b=G;return b}function j(){var b,c,d,e,f,h,i,j;if(b=cb,c=k(),c!==G){for(d=[],e=cb,f=D(),f!==G?(38===a.charCodeAt(cb)?(h=M,cb++):(h=G,0===hb&&g(N)),h!==G?(i=D(),i!==G?(j=k(),j!==G?(f=[f,h,i,j],e=f):(cb=e,e=G)):(cb=e,e=G)):(cb=e,e=G)):(cb=e,e=G);e!==G;)d.push(e),e=cb,f=D(),f!==G?(38===a.charCodeAt(cb)?(h=M,cb++):(h=G,0===hb&&g(N)),h!==G?(i=D(),i!==G?(j=k(),j!==G?(f=[f,h,i,j],e=f):(cb=e,e=G)):(cb=e,e=G)):(cb=e,e=G)):(cb=e,e=G);d!==G?(db=b,c=O(c,d),b=c):(cb=b,b=G)}else cb=b,b=G;return b}function k(){var b,c,d,e,f,h;return b=cb,40===a.charCodeAt(cb)?(c=P,cb++):(c=G,0===hb&&g(Q)),c!==G?(d=D(),d!==G?(e=i(),e!==G?(f=D(),f!==G?(41===a.charCodeAt(cb)?(h=R,cb++):(h=G,0===hb&&g(S)),h!==G?(db=b,c=T(e),b=c):(cb=b,b=G)):(cb=b,b=G)):(cb=b,b=G)):(cb=b,b=G)):(cb=b,b=G),b===G&&(b=l()),b}function l(){var a;return a=n(),a===G&&(a=o(),a===G&&(a=q(),a===G&&(a=p(),a===G&&(a=m())))),a}function m(){var b,c,d;return hb++,b=cb,a.substr(cb,5)===V?(c=V,cb+=5):(c=G,0===hb&&g(W)),c!==G?(d=r(),d!==G?(db=b,c=X(d),b=c):(cb=b,b=G)):(cb=b,b=G),hb--,b===G&&(c=G,0===hb&&g(U)),b}function n(){var b,c,d;return hb++,b=cb,a.substr(cb,3)===Z?(c=Z,cb+=3):(c=G,0===hb&&g($)),c!==G?(d=s(),d!==G?(db=b,c=_(d),b=c):(cb=b,b=G)):(cb=b,b=G),hb--,b===G&&(c=G,0===hb&&g(Y)),b}function o(){var b,c,d,e;return hb++,b=cb,a.substr(cb,5)===ba?(c=ba,cb+=5):(c=G,0===hb&&g(ca)),c!==G?(62===a.charCodeAt(cb)?(d=da,cb++):(d=G,0===hb&&g(ea)),d===G&&(60===a.charCodeAt(cb)?(d=fa,cb++):(d=G,0===hb&&g(ga)),d===G&&(a.substr(cb,2)===ha?(d=ha,cb+=2):(d=G,0===hb&&g(ia)),d===G&&(a.substr(cb,2)===ja?(d=ja,cb+=2):(d=G,0===hb&&g(ka))))),d===G&&(d=null),d!==G?(e=r(),e!==G?(db=b,c=la(d,e),b=c):(cb=b,b=G)):(cb=b,b=G)):(cb=b,b=G),hb--,b===G&&(c=G,0===hb&&g(aa)),b}function p(){var b,c,d;return hb++,b=cb,a.substr(cb,4)===na?(c=na,cb+=4):(c=G,0===hb&&g(oa)),c!==G?(d=r(),d!==G?(db=b,c=pa(d),b=c):(cb=b,b=G)):(cb=b,b=G),hb--,b===G&&(c=G,0===hb&&g(ma)),b}function q(){var b,c,d,e,f;return hb++,b=cb,a.substr(cb,6)===ra?(c=ra,cb+=6):(c=G,0===hb&&g(sa)),c!==G?(d=s(),d!==G?(58===a.charCodeAt(cb)?(e=ta,cb++):(e=G,0===hb&&g(ua)),e!==G?(f=r(),f!==G?(db=b,c=va(d,f),b=c):(cb=b,b=G)):(cb=b,b=G)):(cb=b,b=G)):(cb=b,b=G),hb--,b===G&&(c=G,0===hb&&g(qa)),b}function r(){var a,b;return hb++,a=s(),a===G&&(a=t()),hb--,a===G&&(b=G,0===hb&&g(wa)),a}function s(){var b,c,d;if(hb++,b=cb,c=[],ya.test(a.charAt(cb))?(d=a.charAt(cb),cb++):(d=G,0===hb&&g(za)),d!==G)for(;d!==G;)c.push(d),ya.test(a.charAt(cb))?(d=a.charAt(cb),cb++):(d=G,0===hb&&g(za));else c=G;return c!==G&&(db=b,c=Aa()),b=c,hb--,b===G&&(c=G,0===hb&&g(xa)),b}function t(){var b,c,d,e,f;return hb++,b=cb,47===a.charCodeAt(cb)?(c=Ca,cb++):(c=G,0===hb&&g(Da)),c!==G?(d=cb,e=u(),d=e!==G?a.substring(d,cb):e,d!==G?(47===a.charCodeAt(cb)?(e=Ca,cb++):(e=G,0===hb&&g(Da)),e!==G?(103===a.charCodeAt(cb)?(f=Ea,cb++):(f=G,0===hb&&g(Fa)),f===G&&(109===a.charCodeAt(cb)?(f=Ga,cb++):(f=G,0===hb&&g(Ha)),f===G&&(105===a.charCodeAt(cb)?(f=Ia,cb++):(f=G,0===hb&&g(Ja)),f===G&&(f=Ka))),f!==G?(db=b,c=La(d,f),b=c):(cb=b,b=G)):(cb=b,b=G)):(cb=b,b=G)):(cb=b,b=G),hb--,b===G&&(c=G,0===hb&&g(Ba)),b}function u(){var a,b,c,d;if(a=cb,b=v(),b!==G){for(c=[],d=w();d!==G;)c.push(d),d=w();c!==G?(b=[b,c],a=b):(cb=a,a=G)}else cb=a,a=G;return a}function v(){var b,c,d;return b=cb,c=cb,hb++,Ma.test(a.charAt(cb))?(d=a.charAt(cb),cb++):(d=G,0===hb&&g(Na)),hb--,d===G?c=void 0:(cb=c,c=G),c!==G?(d=y(),d!==G?(c=[c,d],b=c):(cb=b,b=G)):(cb=b,b=G),b===G&&(b=x(),b===G&&(b=z())),b}function w(){var b,c,d;return b=cb,c=cb,hb++,Oa.test(a.charAt(cb))?(d=a.charAt(cb),cb++):(d=G,0===hb&&g(Pa)),hb--,d===G?c=void 0:(cb=c,c=G),c!==G?(d=y(),d!==G?(c=[c,d],b=c):(cb=b,b=G)):(cb=b,b=G),b===G&&(b=x(),b===G&&(b=z())),b}function x(){var b,c,d;return b=cb,92===a.charCodeAt(cb)?(c=Qa,cb++):(c=G,0===hb&&g(Ra)),c!==G?(d=y(),d!==G?(c=[c,d],b=c):(cb=b,b=G)):(cb=b,b=G),b}function y(){var a,b,c;return a=cb,b=cb,hb++,c=B(),hb--,c===G?b=void 0:(cb=b,b=G),b!==G?(c=C(),c!==G?(b=[b,c],a=b):(cb=a,a=G)):(cb=a,a=G),a}function z(){var b,c,d,e;if(b=cb,91===a.charCodeAt(cb)?(c=Sa,cb++):(c=G,0===hb&&g(Ta)),c!==G){for(d=[],e=A();e!==G;)d.push(e),e=A();d!==G?(93===a.charCodeAt(cb)?(e=Ua,cb++):(e=G,0===hb&&g(Va)),e!==G?(c=[c,d,e],b=c):(cb=b,b=G)):(cb=b,b=G)}else cb=b,b=G;return b}function A(){var b,c,d;return b=cb,c=cb,hb++,Wa.test(a.charAt(cb))?(d=a.charAt(cb),cb++):(d=G,0===hb&&g(Xa)),hb--,d===G?c=void 0:(cb=c,c=G),c!==G?(d=y(),d!==G?(c=[c,d],b=c):(cb=b,b=G)):(cb=b,b=G),b===G&&(b=x()),b}function B(){var b;return Ya.test(a.charAt(cb))?(b=a.charAt(cb),cb++):(b=G,0===hb&&g(Za)),b}function C(){var b;return a.length>cb?(b=a.charAt(cb),cb++):(b=G,0===hb&&g($a)),b}function D(){var b,c;for(hb++,b=[],ab.test(a.charAt(cb))?(c=a.charAt(cb),cb++):(c=G,0===hb&&g(bb));c!==G;)b.push(c),ab.test(a.charAt(cb))?(c=a.charAt(cb),cb++):(c=G,0===hb&&g(bb));return hb--,b===G&&(c=G,0===hb&&g(_a)),b}var E,F=arguments.length>1?arguments[1]:{},G={},H={Query:i},I=i,J="|",K={type:"literal",value:"|",description:'"|"'},L=function(a,b){return b.length>0?{type:"or",content:[a].concat(b.map(function(a,c){return b[c][3]}))}:a},M="&",N={type:"literal",value:"&",description:'"&"'},O=function(a,b){return b.length>0?{type:"and",content:[a].concat(b.map(function(a,c){return b[c][3]}))}:a},P="(",Q={type:"literal",value:"(",description:'"("'},R=")",S={type:"literal",value:")",description:'")"'},T=function(a){return a},U={type:"other",description:"name:"},V="name:",W={type:"literal",value:"name:",description:'"name:"'},X=function(a){return{type:"name",content:a}},Y={type:"other",description:"is:"},Z="is:",$={type:"literal",value:"is:",description:'"is:"'},_=function(a){return{type:"is",content:a}},aa={type:"other",description:"vers:"},ba="vers:",ca={type:"literal",value:"vers:",description:'"vers:"'},da=">",ea={type:"literal",value:">",description:'">"'},fa="<",ga={type:"literal",value:"<",description:'"<"'},ha=">=",ia={type:"literal",value:">=",description:'">="'},ja="<=",ka={type:"literal",value:"<=",description:'"<="'},la=function(a,b){var c={type:"vers",content:b};return">"===a&&(c.operator="gt"),"<"===a&&(c.operator="lt"),">="===a&&(c.operator="ge"),"<="===a&&(c.operator="le"),c},ma={type:"other",description:"tag:"},na="tag:",oa={type:"literal",value:"tag:",description:'"tag:"'},pa=function(a){return{type:"tag",content:a}},qa={type:"other",description:"bound:"},ra="bound:",sa={type:"literal",value:"bound:",description:'"bound:"'},ta=":",ua={type:"literal",value:":",description:'":"'},va=function(a,b){return{type:"bound",target:a,content:b}},wa={type:"other",description:"identifier or regex"},xa={type:"other",description:"identifier"},ya=/^[a-zA-Z0-9.]/,za={type:"class",value:"[a-zA-Z0-9\\.]",description:"[a-zA-Z0-9\\.]"},Aa=function(){return c()},Ba={type:"other",description:"regular expression"},Ca="/",Da={type:"literal",value:"/",description:'"/"'},Ea="g",Fa={type:"literal",value:"g",description:'"g"'},Ga="m",Ha={type:"literal",value:"m",description:'"m"'},Ia="i",Ja={type:"literal",value:"i",description:'"i"'},Ka="",La=function(a,b){var c;try{c=new RegExp(a,b)}catch(a){d(a.message)}return{type:"regex",content:c}},Ma=/^[*\\\/[]/,Na={type:"class",value:"[*\\\\/[]",description:"[*\\\\/[]"},Oa=/^[\\\/[]/,Pa={type:"class",value:"[\\\\/[]",description:"[\\\\/[]"},Qa="\\",Ra={type:"literal",value:"\\",description:'"\\\\"'},Sa="[",Ta={type:"literal",value:"[",description:'"["'},Ua="]",Va={type:"literal",value:"]",description:'"]"'},Wa=/^[\]\\]/,Xa={type:"class",value:"[\\]\\\\]",description:"[\\]\\\\]"},Ya=/^[\n\r\u2028\u2029]/,Za={type:"class",value:"[\\n\\r\\u2028\\u2029]",description:"[\\n\\r\\u2028\\u2029]"},$a={type:"any",description:"any character"},_a={type:"other",description:"whitespace"},ab=/^[ \t]/,bb={type:"class",value:"[ \\t]",description:"[ \\t]"},cb=0,db=0,eb=[{line:1,column:1,seenCR:!1}],fb=0,gb=[],hb=0;if("startRule"in F){if(!(F.startRule in H))throw new Error("Can't start parsing from rule \""+F.startRule+'".');I=H[F.startRule]}if(E=I(),E!==G&&cb===a.length)return E;throw E!==G&&cb<a.length&&g({type:"end",description:"end of input"}),h(null,gb,fb<a.length?a.charAt(fb):null,fb<a.length?f(fb,fb+1):f(fb,fb))}return a(b,Error),{SyntaxError:b,parse:c}}),angular.module("editorApp").filter("doFilter",function(){function a(a,b){return b.type&&"regex"===b.type?b.content.test(a):a===b}function b(b,c){var d=a(b.name,c.content);return!d&&b.children?b.children.some(function(b){return a(b.name,c.content)}):d}function c(a,c){return a.filter(function(a){return b(a,c)})}function d(a,b){var c;switch(b.content){case"node":c="node"===a.type;break;case"chan":case"channel":c="channel"===a.type;break;case"comp":case"component":c="component"===a.type;break;case"group":case"grp":c="group"===a.type;break;case"selected":c=a.selected;break;case"folded":c=a.folded;break;default:c=!1}return!c&&a.children?a.children.some(function(a){return d(a,b)}):c}function e(a,b){return a.filter(function(a){return d(a,b)})}function f(b,c){var d=b.tags.some(function(b){return a(b,c.content)});return!d&&b.children?b.children.some(function(a){return f(a,c)}):d}function g(a,b){return a.filter(function(a){return f(a,b)})}function h(b,c){var d=a(b.version,c.content);return!d&&b.children?b.children.some(function(a){return h(a,c)}):d}function i(a,b){return a.filter(function(a){return h(a,b)})}function j(a,b){var c=a;return b.content.forEach(function(a){c=l(c,a)}),c}function k(a,b){var c=[],d=[];return b.content.forEach(function(b){var e=a.filter(function(a){return c.indexOf(a.path)===-1}),f=l(e,b);f.forEach(function(a){c.indexOf(a.path)===-1&&c.push(a.path)}),d=d.concat(f)}),d}var l=function(){};return l=function(a,b){if(a){if(!b)return a;switch(b.type){case"name":return c(a,b);case"is":return e(a,b);case"tag":return g(a,b);case"vers":return i(a,b);case"and":return j(a,b);case"or":return k(a,b);default:return a}}}}),angular.module("editorApp").directive("tabActions",["$filter","$modal","kEditor",function(a,b,c){return{restrict:"E",scope:!0,templateUrl:"scripts/app/treeview/tab-actions/tab-actions.html",link:function(d){function e(){var b=c.getModel();d.groups=b.groups.array,d.selectedGroup=a("orderBy")(d.groups,"name")[0]}function f(){d.tags={},d.items.forEach(function a(b){b.tags.forEach(function(a){d.tags[a]||(d.tags[a]=[]),d.tags[a].push(b)}),b.children&&b.children.forEach(a)}),d.tagsCount=Object.keys(d.tags).length}function g(){e(),f()}g();var h=d.$watchCollection("items",g),i=d.$watch("items",function(){f()},!0);d.$on("$destroy",function(){h(),i()}),d.openGroupModal=function(){b.open({templateUrl:"scripts/app/main/instance/group.modal.html",size:"md",resolve:{group:function(){return d.selectedGroup}},controller:"GroupModalCtrl"})}}}}]),angular.module("editorApp").directive("tabCreate",["$timeout","$filter","kFactory","kEditor","kInstance","kModelHelper","util","KWE_TAG",function(a,b,c,d,e,f,g,h){return{restrict:"E",scope:!0,templateUrl:"scripts/app/treeview/tab-create/tab-create.html",link:function(a){function g(a){return{name:f.getFqn(a),tdef:a}}function i(){var b=d.getModel();a.tags="",a.name="",a.types=["node","group","channel","component"],a.instanceTypes={node:f.getNodeTypes(b).map(g),group:f.getGroupTypes(b).map(g),channel:f.getChannelTypes(b).map(g),component:f.getComponentTypes(b).map(g)},a.selectedType=a.types[0],a.instanceTypes[a.selectedType].length>0&&(a.selectedInstanceType=a.instanceTypes[a.selectedType][0]),a.availableNodes=a.items.filter(function(a){return"node"===a.type}),a.selectedNode=a.availableNodes[0],a.instancesCount=1,a.verifyName()}a.namePattern="{metatype}{index}",a.state={started:!0},a.tags="",a.verifyName=function(){var c,e;switch(a.selectedType){case"node":for(c=0;c<a.instancesCount;c++)if(e=b("namingPattern")(a.namePattern,{index:c,metatype:a.selectedType}),d.getModel().findNodesByID(e))return void(a.message={type:"danger",content:'There is already a node named "'+e+'"'});break;case"group":for(c=0;c<a.instancesCount;c++)if(e=b("namingPattern")(a.namePattern,{index:c,metatype:a.selectedType}),d.getModel().findGroupsByID(e))return void(a.message={type:"danger",content:'There is already a group named "'+e+'"'});break;case"channel":for(c=0;c<a.instancesCount;c++)if(e=b("namingPattern")(a.namePattern,{index:c,metatype:a.selectedType}),d.getModel().findHubsByID(e))return void(a.message={type:"danger",content:'There is already a channel named "'+e+'"'});break;case"component":if(a.selectedNode)for(c=0;c<a.instancesCount;c++)if(e=b("namingPattern")(a.namePattern,{index:c,metatype:a.selectedType}),d.getModel().findNodesByID(a.selectedNode.name).findComponentsByID(e))return void(a.message={type:"danger",content:'There is already a component named "'+e+'" in node "'+a.selectedNode.name+'"'})}a.message=null},i();var j=d.addNewModelListener("treeview",i),k=a.$watchCollection("items",i);a.$on("$destroy",function(){j(),k()}),a.create=function(){for(var f=d.getModel(),g=0;g<a.instancesCount;g++){var i,j=b("namingPattern")(a.namePattern,{index:g,metatype:a.selectedType});switch(a.selectedType){case"node":i=c.createContainerNode();break;case"group":i=c.createGroup();break;case"channel":i=c.createChannel();break;case"component":i=c.createComponentInstance()}i.name=j,i.typeDefinition=a.selectedInstanceType.tdef,i.started=a.state.started,e.initDictionaries(i);var k=a.tags.split(",").map(function(a){return a.trim()}).filter(function(a){return a.length>0}).join(","),l=c.createValue();switch(l.name=h,l.value=k,i.addMetaData(l),a.selectedType){case"node":f.addNodes(i),a.createItem(a.selectedType,i);break;case"group":f.addGroups(i),a.createItem(a.selectedType,i);break;case"channel":f.addHubs(i),a.createItem(a.selectedType,i);break;case"component":var m=f.findNodesByID(a.selectedNode.name);m.addComponents(i),a.createItem(a.selectedType,i,m)}}},a.onTypeChange=function(){a.instanceTypes[a.selectedType].length>0&&(a.selectedInstanceType=b("isCompatible")(a.instanceTypes[a.selectedType],a.selectedType,a.selectedNode?a.selectedNode.name:null)[0],a.verifyName())},a.onSelectedNodeChange=function(c){a.selectedNode=c,a.selectedInstanceType=b("isCompatible")(a.instanceTypes[a.selectedType],a.selectedType,a.selectedNode?a.selectedNode.name:null)[0],a.verifyName()},a.areInstanceTypesValid=function(){return"component"===a.selectedType?a.availableNodes.length>0&&a.instanceTypes[a.selectedType].length>0:a.instanceTypes[a.selectedType].length>0},a.isValid=function(){return!("component"===a.selectedType&&!a.selectedNode)&&(!a.message&&a.namePattern.trim().length>0&&a.selectedType.length>0&&a.instancesCount>0&&a.selectedInstanceType)}}}}]),angular.module("editorApp").directive("tabParams",["$timeout","kEditor","kModelHelper","kInstance","util",function(a,b,c,d,e){return{restrict:"E",scope:!0,templateUrl:"scripts/app/treeview/tab-params/tab-params.html",link:function(f){function g(a){switch(a){case"LONG":case"DOUBLE":case"FLOAT":case"SHORT":case"INT":return"number";case"BOOLEAN":return"boolean";default:return"text"}}function h(){f.message=null,f.error=!1,f.length={},f.prepend={},f.append={},f.min={},f.max={},f.each={},f.toggleEachFlag=!1,f.state={started:null},f.nets=[];var a=b.getModel();if(f.selectedItems.length>1){var h=a.findByPath(f.selectedItems[0].path);f.types=[h.name+": "+c.getFqn(h.typeDefinition)];for(var i=1;i<f.selectedItems.length;i++){var j=a.findByPath(f.selectedItems[i-1].path),k=a.findByPath(f.selectedItems[i].path);if(c.getFqn(j.typeDefinition)!==c.getFqn(k.typeDefinition))return f.types.push(k.name+": "+c.getFqn(k.typeDefinition)),void(f.error=!0)}}f.selectedItems.forEach(function(a){var c=b.getModel().findByPath(a.path);d.initDictionaries(c)}),f.util=e,f.instance=a.findByPath(f.selectedItems[0].path),1===f.selectedItems.length?f.state.started=f.instance.started:f.state.started=null,f.type=f.instance.typeDefinition,f.typeName=c.getFqn(f.type),f.dictionary=[],f.type.dictionaryType&&(f.dictionary=f.type.dictionaryType.select("attributes[fragmentDependant=false]").array.map(function(a){var b,d=g(a.datatype.name());if(1===f.selectedItems.length&&f.instance.dictionary){var e=f.instance.dictionary.findValuesByID(a.name);if(e)switch(d){case"number":b=+e.value;break;default:b=e.value}}var h={name:a.name,optional:c.isTruish(a.optional),defaultValue:a.defaultValue,type:d,value:b};return h})),f.instance.networkInformation&&f.instance.networkInformation.array.forEach(function(a){f.nets.push({name:a.name,values:a.values.array.map(function(a){return{name:a.name,value:a.value}})})})}h();var i=f.$watchCollection("selectedItems",h);f.$on("$destroy",i),f.applyToAllInstances=function(){try{f.selectedItems.forEach(function(a){var c=b.getModel().findByPath(a.path);c.started=f.state.started,f.dictionary.forEach(function(a){var b=c.dictionary.findValuesByID(a.name);f.each[a.name]&&f.random(a),b.value=a.value})}),f.dictionary.forEach(function(a){a.value=null}),h(),f.message={type:"success",content:"Success"}}catch(a){f.message={type:"danger",content:"Error (check console for more information)"
},console.error(a)}a(function(){f.message=null},1500)},f.random=function(a){switch(a.type){case"text":a.value=f.prepend[a.name]+e.randomString(f.length[a.name])+f.append[a.name];break;case"number":a.value=e.randomNumber(f.min[a.name],f.max[a.name]);break;case"boolean":a.value=e.randomBoolean()+""}},f.allRandom=function(){f.dictionary.forEach(f.random)},f.toggleEach=function(){f.toggleEachFlag=!f.toggleEachFlag,Object.keys(f.each).forEach(function(a){f.each[a]=f.toggleEachFlag})}}}}]),angular.module("editorApp").directive("tabTags",function(){return{restrict:"E",scope:!0,templateUrl:"scripts/app/treeview/tab-tags/tab-tags.html",controller:["$scope","kEditor","kFactory","kModelHelper","KWE_TAG",function(a,b,c,d,e){function f(){a.tags=[],a.selectedItems.forEach(function(c){var e=b.getModel().findByPath(c.path);d.getTags(e).forEach(function(b){a.tags.indexOf(b)===-1&&a.tags.push(b)})})}function g(a,b){var c=b.split(","),d=c.indexOf(a);return d!==-1&&c.splice(d,1),c}a.tag="",a.tags=[],f();var h=a.$watchCollection("selectedItems",f);a.$on("$destroy",h),a.addTag=function(){a.tag.trim().length>0&&a.tag.indexOf(",")===-1&&(a.tag=a.tag.trim(),a.selectedItems.forEach(function(f){var g=b.getModel().findByPath(f.path),h=g.findMetaDataByID(e);h||(h=c.createValue(),h.name=e,h.value="",g.addMetaData(h));var i=d.getTags(g);i.indexOf(a.tag)===-1&&(i.push(a.tag),f.tags.push(a.tag)),a.tags.indexOf(a.tag)===-1&&a.tags.push(a.tag),h.value=i.join(",")}),a.tag="")},a.validate=function(){a.tag.indexOf(",")!==-1?a.error='Character "," is not allowed in a tag':a.error=null},a.removeTag=function(c){a.tags.splice(a.tags.indexOf(c),1),a.selectedItems.forEach(function(a){var d=b.getModel().findByPath(a.path),f=d.findMetaDataByID(e);if(f){var h=g(c,f.value);f.value=h.join(","),a.tags=h}})}}]}}),angular.module("editorApp").directive("tabJson",["$timeout","kFactory","kEditor",function(a,b,c){return{restrict:"E",scope:!0,templateUrl:"scripts/app/treeview/tab-json/tab-json.html",link:function(d){function e(){var a=c.getModel().select(d.path);a?d.elems=a.array.map(function(a){return d.collapsed.hasOwnProperty(a.path())||(d.collapsed[a.path()]=!0),{path:a.path(),content:JSON.stringify(JSON.parse(g.serialize(a)),null,2)}}):d.elems.length=0}var f,g=b.createJSONSerializer();d.path="",d.elems=[],d.collapsed={},d.onPathChanged=function(){a.cancel(f),f=a(function(){e()},500)},e(),d.setPath=function(a){d.path=a,e()};var h=c.addNewModelListener("treeview",e);d.$on("$destroy",function(){h(),a.cancel(f)})}}}]),angular.module("editorApp").factory("kEditor",["$timeout","kFactory","kModelHelper","kInstance","ui","Notification","KWE_POSITION","KWE_FOLDED","KWE_SELECTED","KWE_TAG","CHANNEL_RADIUS","GROUP_RADIUS",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(a){return function(b){function j(a){a.components.array.forEach(function(a){a.provided.array.forEach(function(a){a.bindings.array.forEach(function(a){e.editor&&e.createBinding(a)})}),a.required.array.forEach(function(a){a.bindings.array.forEach(function(a){e.editor&&e.createBinding(a)})})}),a.groups.array.forEach(function(b){e.editor&&e.createGroupWire(b,a)}),a.hosts.array.forEach(j)}var k,l;a.invokeModelUpdateListeners(),"typeDefinitions"!==b.elementAttributeName&&"packages"!==b.elementAttributeName||a.invokeModelUpdateListeners("tdefs");try{if(b.etype===KevoreeLibrary.modeling.api.util.ActionType.object.REMOVE)"/"===b.previousPath?"hubs"===b.elementAttributeName||"nodes"===b.elementAttributeName||"groups"===b.elementAttributeName?(e.editor&&e.deleteInstance(b.source,b.previous_value),a.invokeModelUpdateListeners("selected")):"mBindings"===b.elementAttributeName&&e.editor&&e.deleteBinding(b.previous_value):"hosts"===b.elementAttributeName||"components"===b.elementAttributeName?(e.editor&&e.deleteInstance(b.source,b.previous_value),a.invokeModelUpdateListeners("selected")):"groups"===b.elementAttributeName?(e.editor&&e.deleteGroupWire(b.previous_value,b.previousPath),k=b.value.findFragmentDictionaryByID(b.source.name),k&&k.delete()):"bindings"===b.elementAttributeName&&"hubs"===b.source.getRefInParent()&&b.source.fragmentDictionary.array.forEach(function(a){for(var c=!1,d=0;d<b.source.bindings.size();d++){var e=b.source.bindings.get(d);if(e.port&&e.port.eContainer().eContainer().name===a.name){c=!0;break}}c||a.delete()});else if(b.etype===KevoreeLibrary.modeling.api.util.ActionType.object.REMOVE_ALL)if("/"===b.previousPath)switch(b.elementAttributeName){case"hubs":e.editor&&e.deleteChannels();break;case"nodes":e.editor&&e.deleteNodes();break;case"groups":e.editor&&e.deleteGroups();break;case"mBindings":e.editor&&e.deleteBindings()}else switch(b.elementAttributeName){case"groups":b.value.array.forEach(function(a){e.editor&&e.deleteGroupWire(a.path(),b.previousPath);var c=a.findFragmentDictionaryByID(b.source.name);c&&c.delete()});break;case"bindings":b.value.array.forEach(function(a){e.editor&&e.deleteBinding(a.path()),a.hub&&a.port||a.delete()})}else if(b.etype===KevoreeLibrary.modeling.api.util.ActionType.object.ADD)if("/"===b.previousPath)switch(b.elementAttributeName){case"hubs":e.editor&&e.createChannel(b.value);break;case"nodes":case"hosts":e.editor&&(e.createNode(b.value),l=c.getHighestNode(b.value),l&&e.refreshNode(l.path()));break;case"groups":e.editor&&e.createGroup(b.value);break;case"mBindings":e.editor&&e.createBinding(b.value)}else switch(b.elementAttributeName){case"groups":e.editor&&e.createGroupWire(b.value,b.source);break;case"components":e.editor&&e.createComponent(b.value),l=c.getHighestNode(b.value),e.editor&&e.refreshNode(l.path()),j(l);break;case"hosts":e.editor&&e.createNode(b.value),b.value.components.array.forEach(function(a){e.editor&&e.createComponent(a)}),b.value.hosts.array.sort(function(a,b){return c.getNodeTreeHeight(b)-c.getNodeTreeHeight(a)}).forEach(function a(b){e.editor&&e.createNode(b),b.components.array.forEach(function(a){e.editor&&e.createComponent(a)}),b.hosts.array.forEach(a)}),l=c.getHighestNode(b.source),e.editor&&e.refreshNode(l.path()),j(l);break;case"subNodes":d.initFragmentDictionaries(b.source),a.invokeModelUpdateListeners("selected");break;case"bindings":a.invokeModelUpdateListeners("selected");break;case"metaData":b.value.name===h&&"nodes"===b.source.getRefInParent()&&e.editor&&e.toggleFold(b.source,c.isTruish(b.value.value))}else if(b.etype===KevoreeLibrary.modeling.api.util.ActionType.object.SET)switch(b.elementAttributeName){case"name":"nodes"===b.source.getRefInParent()&&(b.source.groups.array.forEach(function(a){k=a.findFragmentDictionaryByID(b.previous_value),k&&(k.name=b.source.name)}),b.source.components.array.forEach(function(a){function c(a){a.bindings.array.forEach(function(a){a.hub&&(k=a.hub.findFragmentDictionaryByID(b.previous_value),k&&(k.name=b.source.name))})}a.provided.array.forEach(c),a.required.array.forEach(c)})),e.editor&&e.updateInstance(b.previousPath,b.source);break;case"value":"metaData"===b.source.getRefInParent()&&b.source.name===g?(e.editor&&e.updatePosition(b.source.eContainer()),"nodes"===b.source.eContainer().getRefInParent()?j(b.source.eContainer()):"groups"===b.source.eContainer().getRefInParent()?b.source.eContainer().subNodes.array.forEach(function(a){e.editor&&e.createGroupWire(b.source.eContainer(),a)}):"hubs"===b.source.eContainer().getRefInParent()&&b.source.eContainer().bindings.array.forEach(function(a){e.editor&&e.createBinding(a)})):"metaData"===b.source.getRefInParent()&&b.source.name===h?"nodes"===b.source.eContainer().getRefInParent()&&e.editor&&e.toggleFold(b.source.eContainer(),c.isTruish(b.source.value)):"dictionary"===b.source.eContainer().getRefInParent()?e.editor&&e.updateValidity(b.source.eContainer().eContainer()):"metaData"===b.source.getRefInParent()&&b.source.name===i&&a.invokeModelUpdateListeners("selected");break;case"started":e.editor&&e.updateInstance(b.previousPath,b.source);break;case"typeDefinition":if(null!==b.value)switch(b.source.getRefInParent()){case"components":e.editor&&e.updateCompTypeDefinition(b.source,b.previous_value)}}}catch(a){f.error({title:"Error",message:"Unable to update model"}),console.error(a.stack)}}}function n(){this.model=b.createContainerRoot().withGenerated_KMF_ID(0),b.root(this.model),this.preSetModelHandler=[],this.postSetModelHandler=[],this.modelUpdateListenersEnabled=!0,this.modelUpdateListeners=[],this.newModelListeners=[],this.modelListener={elementChanged:m(this)},e.setModel(this.model)}return n.prototype={getModel:function(){return this.model},setModel:function(c,d){this.preSetModelHandler.forEach(function(a){a()}),setTimeout(function(){var f;try{KevoreeValidator(c),this.model=c,b.root(this.model),this.model.addModelTreeListener(this.modelListener),e.setModel(c),this.invokeNewModelListeners()}catch(a){f=a}finally{f&&console.error(f.stack),this.postSetModelHandler.forEach(function(a){a()}),d&&a(angular.noop,100).then(function(){d(f)})}}.bind(this),20)},merge:function(a){this.model.removeModelTreeListener(this.modelListener);var c=b.createModelCompare();c.merge(this.model,a).applyOn(this.model),b.root(this.model),this.model.addModelTreeListener(this.modelListener),e.setModel(this.model),this.drawModel()},addPreSetModelHandler:function(a){var b=this.preSetModelHandler.push(a)-1;return function(){this.preSetModelHandler.splice(b,1)}.bind(this)},addPostSetModelHandler:function(a){var b=this.postSetModelHandler.push(a)-1;return function(){this.postSetModelHandler.splice(b,1)}.bind(this)},addNewModelListener:function(a,b){return this.newModelListeners[a]||(this.newModelListeners[a]=[]),this.newModelListeners[a].push(b),function(){this.newModelListeners[a]&&this.newModelListeners[a].splice(this.newModelListeners[a].indexOf(b),1)}.bind(this)},addModelUpdateListener:function(a,b,c){this.modelUpdateListeners[a]||(this.modelUpdateListeners[a]=[]);var d={strict:c,listener:b};return this.modelUpdateListeners[a].push(d),function(){this.modelUpdateListeners[a]&&this.modelUpdateListeners[a].splice(this.modelUpdateListeners[a].indexOf(d),1)}.bind(this)},invokeModelUpdateListeners:function(a){this.modelUpdateListenersEnabled&&Object.keys(this.modelUpdateListeners).forEach(function(b){this.modelUpdateListeners[b].forEach(function(c){c.strict?b===a&&c.listener():c.listener()})}.bind(this))},invokeNewModelListeners:function(){Object.keys(this.newModelListeners).forEach(function(a){this.newModelListeners[a].forEach(function(a){a()})}.bind(this))},disableModelUpdateListeners:function(){this.modelUpdateListenersEnabled=!1},enableModelUpdateListeners:function(){this.modelUpdateListenersEnabled=!0},removeAllListeners:function(){var a;for(a in this.modelUpdateListeners)delete this.modelUpdateListeners[a];for(a in this.newModelListeners)delete this.newModelListeners[a]},removeModelUpdateListeners:function(a){delete this.modelUpdateListeners[a]},removeNewModelListeners:function(a){delete this.newModelListeners[a]},fixOverlapping:function(){function a(a,c){var d=a.findMetaDataByID(g);d?d.value=JSON.stringify(c):(d=b.createValue(),d.name=g,d.value=JSON.stringify(c),a.addMetaData(d))}var d=l+20;this.model.groups.array.forEach(function(b){a(b,{x:d,y:l+20}),d+=2*l+20});var e=k+20;this.model.hubs.array.forEach(function(b){a(b,{x:e,y:180}),e+=2*k+20});var f=25;this.model.nodes.array.forEach(function(b){if(!b.host){var d=c.getNodeTreeHeight(b);a(b,{x:f,y:220}),f+=230+20*d}})},drawModel:function(){e.editor&&(this.model.hubs.array.forEach(function(a){e.createChannel(a)}),this.model.nodes.array.sort(function(a,b){return c.getNodeTreeHeight(b)-c.getNodeTreeHeight(a)}).forEach(function(a){e.createNode(a),a.components.array.forEach(function(a){e.createComponent(a)})}),this.model.groups.array.forEach(function(a){e.createGroup(a),a.subNodes.array.forEach(function(b){e.createGroupWire(a,b)})}),this.model.mBindings.array.forEach(function(a){e.createBinding(a)}),e.order(),this.model.select("**/metaData[name="+h+"]").array.forEach(function(a){e.toggleFold(a.eContainer(),c.isFolded(a.eContainer()))}))},modelHasErrors:function(){return!1}},new n}]),angular.module("editorApp").factory("kScript",function(){return new KevoreeKevscript(new KevoreeCommons.Logger("KevScript"))}),angular.module("editorApp").directive("kdic",function(){return{restrict:"E",scope:{name:"=",attrs:"=",dictionary:"=",fragment:"="},templateUrl:"scripts/components/kevoree/dictionary.html",controller:["$scope",function(a){a.isTruish=function(a){return"true"===a||a===!0||a>0},a.isReadOnly=function(){if(a.dictionary&&a.dictionary.eContainer()){var b=a.dictionary.eContainer().findMetaDataByID("access_mode");return b&&"read-only"===b.value}return!1}}]}}),angular.module("editorApp").directive("stringToNumber",function(){return{require:"ngModel",link:function(a,b,c,d){d.$parsers.push(function(a){return a}),d.$formatters.push(function(a){return parseFloat(a)})}}}),angular.module("editorApp").directive("instanceName",["kEditor",function(a){return{restrict:"A",require:"ngModel",scope:{instance:"&instance",instanceType:"&instanceType"},link:function(b,c,d,e){e.$parsers.push(function(c){var d,f=a.getModel();switch(b.instanceType()){case"node":d=f.findNodesByID(c);break;case"group":d=f.findGroupsByID(c);break;case"channel":d=f.findHubsByID(c);break;case"component":d=b.instance().eContainer().findComponentsByID(c)}return d?d.path()===b.instance().path()?e.$setValidity("notUniqueName",!0):e.$setValidity("notUniqueName",!1):e.$setValidity("notUniqueName",!0),c})}}}]),angular.module("editorApp").factory("kFactory",function(){return new KevoreeLibrary.factory.DefaultKevoreeFactory}),angular.module("editorApp").directive("loadingOverlay",["kEditor",function(a){return{restrict:"A",scope:!1,link:function(b,c){function d(){c.append(g)}function e(){g.remove()}var f="id_"+Math.floor(1e4*Math.random()+1),g=angular.element("<div>",{id:f,class:"overlay"}).append(angular.element("<p>",{class:"center-message"}).html("Loading model...")),h=a.addPreSetModelHandler(d),i=a.addPostSetModelHandler(e);b.$on("$destroy",function(){h(),i()})}}}]),angular.module("editorApp").factory("ui",["util","uiUtils","uiCreateGroup","uiCreateGroupWire","uiCreateNode","uiCreateComponent","uiCreateBinding","uiCreateChannel","kModelHelper","kFactory","Notification","KWE_POSITION","NODE_WIDTH","NODE_HEIGHT","INVALID_RADIUS","GROUP_RADIUS","CHANNEL_RADIUS",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){var r={model:null,overedInstancePath:null,draggedInstancePath:null,mousePos:{x:0,y:0},init:function(){var a=new Snap("svg#editor");a.zpd({zoomThreshold:[.2,1],zoomScale:.05});var c=this.editor=a.select("#snapsvg-zpd-"+a.id);c.addClass("zpd"),a.mousedown(function(b){1===b.which&&a.selectAll(".selected").forEach(function(a){a.removeClass("selected");var b=a.parent().attr("data-path");if(b&&b.length>0){var c=r.model.findByPath(b);i.setSelected(c,!1)}})}),b.updateSVGDefs(this.model);var d=new MutationObserver(function(b){b.forEach(function(b){if("transform"===b.attributeName){var d=c.transform().localMatrix;a.select("#coord-text").attr({text:"("+parseInt(d.e,10)+", "+parseInt(d.f,10)+") "+parseInt(100*d.a,10)+"%"})}})});d.observe(c.node,{attributes:!0,childList:!1,characterData:!1}),a.dblclick(function(){c.animate({transform:"s1,t0,0"},400,mina.ease)}),a.text("100%","100%","(0, 0) 100%").attr({id:"coord-text",fill:"#000",textAnchor:"end"}).transform("t-5,-5")},createGroup:function(a){c(this,a)},createGroupWire:function(a,b){d(this,a,b)},createNode:function(a){e(this,a)},createComponent:function(a){return f(this,a)},createBinding:function(a){g(this,a)},createChannel:function(a){h(this,a)},updateValidity:function(a){if(this.editor){var b=this.editor.select('.instance[data-path="'+a.path()+'"]'),c=this.editor.select('.instance[data-path="'+a.path()+'"] > .invalid-icon');if(i.isValid(a))c&&c.remove();else{c&&c.remove(),c=this.editor.circle(0,0,o).attr({class:"invalid-icon",fill:"red",stroke:"black",title:"Invalid dictionary attributes"});var d=c.transform().localMatrix;switch(i.getTypeDefinitionType(a.typeDefinition)){case"node":d.e=b.getBBox().width-2*o,d.f=2*o;break;case"group":d.f=-p+2*o;break;case"channel":d.f=-q+2*o;break;case"component":d.e=b.getBBox().width}c.transform(d),b.append(c)}}},deleteInstance:function(a,c){var d=this.editor.select('.instance[data-path="'+c+'"]');if(d)if(d.hasClass("comp")||d.hasClass("node")){var e=b.getHighestNodePath(d);r.draggedInstancePath===c?this.editor.append(d):(this.editor.selectAll('.group-wire[data-to="'+c+'"]').remove(),d.remove()),r.refreshNode(e);var f=r.model.findByPath(e);f&&(f.groups.array.forEach(function(a){r.createGroupWire(a,f)}),f.hosts.array.forEach(function a(b){b.groups.array.forEach(function(a){r.createGroupWire(a,b)}),b.hosts.array.forEach(a)}),f.components.array.forEach(function(a){a.provided.array.forEach(function(a){a.bindings.array.forEach(function(a){r.createBinding(a)})}),a.required.array.forEach(function(a){a.bindings.array.forEach(function(a){r.createBinding(a)})})}),f.hosts.array.forEach(function a(b){b.components.array.forEach(function(a){a.provided.array.forEach(function(a){a.bindings.array.forEach(function(a){r.createBinding(a)})}),a.required.array.forEach(function(a){a.bindings.array.forEach(function(a){r.createBinding(a)})})}),b.hosts.array.forEach(a)}))}else d.remove()},deleteGroupWire:function(a,b){var c=this.editor.select('.group-wire[data-from="'+a+'"][data-to="'+b+'"]');c&&c.remove()},deleteBinding:function(a){var b=this.editor.select('.binding[data-path="'+a+'"]');b&&b.remove()},deleteSelected:function(){var a=this.getSelected();return a.forEach(function(a){var b=a.attr("data-path");if(b){var c=r.model.findByPath(b);if(c){var d=!1;if("function"==typeof c.findMetaDataByID){var e=c.findMetaDataByID("access_mode");d=e&&"read-only"===e.value}d?k.warning({title:"Delete instance",message:'Cannot delete read-only instance "'+c.name+'"',delay:3e3}):(c.hosts&&c.hosts.array.forEach(function a(b){b.hosts.array.forEach(a),b.delete()}),c.delete())}}else if(a.hasClass("group-wire")){var f=r.model.findByPath(a.attr("data-from")),g=r.model.findByPath(a.attr("data-to"));g&&f&&(g.removeGroups(f),f.removeSubNodes(g))}}),a.length},removeUIElem:function(a){var b=this.editor.select('.instance[data-path="'+a+'"]');b&&b.remove()},deleteNodes:function(){this.editor.selectAll(".node").remove(),this.editor.selectAll(".group-wire").remove()},deleteGroups:function(){this.editor.selectAll(".group").remove(),this.editor.selectAll(".group-wire").remove()},deleteChannels:function(){this.editor.selectAll(".chan").remove()},deleteBindings:function(){this.editor.selectAll(".binding").remove()},updateInstance:function(b,c){var d=this.editor.select('.instance[data-path="'+b+'"]');if(d){d.attr({"data-path":c.path()});var e=d.select("text.name");e&&e.attr({text:c.name}),d.parent().hasClass("node")||d.relocate(c),(c.components||c.hosts)&&c.components.array.forEach(function(a){var e=d.select('.instance[data-path="'+b+"/components["+a.name+']"]');e&&e.attr({"data-path":a.path().replace(b,c.path())})}),d.hasClass("comp")?d.select(".bg").attr({fillOpacity:a.isTruish(c.started)?1:.65}):e&&e.attr({fill:a.isTruish(c.started)?"#fff":"#000"}),d.hasClass("node")&&this.editor.selectAll('.group-wire[data-to="'+b+'"]').attr({"data-to":c.path()}),d.hasClass("group")&&this.editor.selectAll('.group-wire[data-from="'+b+'"]').attr({"data-from":c.path()})}},updatePosition:function(a){var b=this.editor.select('.instance[data-path="'+a.path()+'"]');b&&(b.parent().hasClass("node")||b.relocate(a))},updateCompTypeDefinition:function(a,b){b.required.array.forEach(function(b){var c=!1;if(a.typeDefinition.required.array.forEach(function(d){if(d.name===b.name){c=!0;var e=a.findRequiredByID(d.name);e&&(e.portTypeRef=d)}}),!c){var d=a.findRequiredByID(b.name);d&&(d.bindings.array.forEach(function(a){a.delete()}),d.delete())}}),b.provided.array.forEach(function(b){var c=!1;if(a.typeDefinition.provided.array.forEach(function(d){if(d.name===b.name){c=!0;var e=a.findProvidedByID(b.name);e&&(e.portTypeRef=d)}}),!c){var d=a.findProvidedByID(b.name);d&&(d.bindings.array.forEach(function(a){a.delete()}),d.delete())}});var c=r.createComponent(a);c.select(".bg").addClass("selected"),this.refreshNode(a.eContainer().path())},toggleFold:function(a,c){function d(a){var b=r.editor.select('.chan[data-path="'+a.path()+'"]');b&&(i.isChannelDistributed(a)?c?b.attr({strokeDasharray:"5 3"}):b.attr({strokeDasharray:""}):c?b.addClass("hide"):b.removeClass("hide"))}function e(a){a.hub&&d(a.hub);var b=r.editor.select('.binding[data-path="'+a.path()+'"]');b&&(c?b.addClass("hide"):b.removeClass("hide"))}function f(a){a.bindings.array.forEach(e)}function g(a){a.provided.array.forEach(f),a.required.array.forEach(f);var b=r.editor.select('.comp[data-path="'+a.path()+'"]');b&&(c?b.addClass("hide"):b.removeClass("hide"))}function h(a){a.components.array.forEach(g),a.hosts.array.forEach(h);var b=r.editor.select('.node[data-path="'+a.path()+'"]');b&&(c?b.addClass("hide"):b.removeClass("hide"))}a.components.array.forEach(g),a.hosts.array.forEach(h);var j=r.editor.select('.node[data-path="'+a.path()+'"]');j&&(c?j.select(".bg").attr({height:n,strokeDasharray:"5 3"}):j.select(".bg").attr({height:b.getNodeUIHeight(a),strokeDasharray:""}))},refreshNode:function(a){var c=r.model.findByPath(a);if(c){var d=r.editor.select('.node[data-path="'+a+'"]'),e=i.getNodeTreeHeight(c),f=m+20*e;c.host&&(f=m+20*(i.getNodeTreeHeight(c.host)-1)),d.relocate(c),d.select(".bg").attr({width:f,height:b.getNodeUIHeight(c)}),r.editor.selectAll('.node[data-path="'+a+'"] > text').attr({x:f/2,"clip-path":"url(#node-clip-"+e+")"}),c.components.array.forEach(function(a){r.refreshComp(a.path())}),c.hosts.array.forEach(function(a){r.refreshNode(a.path())});var g=r.editor.selectAll('.node[data-path="'+c.path()+'"] > .instance').items,h=n;g.forEach(function(a){a.transform("t"+(f-a.select(".bg").asPX("width"))/2+","+h),h+=a.select(".bg").asPX("height")+10}),c.components.array.forEach(function(a){a.provided.array.forEach(function(a){a.bindings.array.forEach(function(a){r.createBinding(a)})}),a.required.array.forEach(function(a){a.bindings.array.forEach(function(a){r.createBinding(a)})})}),this.updateValidity(c)}},refreshComp:function(a){var b=r.model.findByPath(a);if(b){var c=r.editor.select('.comp[data-path="'+a+'"]'),d=r.editor.select('.node[data-path="'+b.eContainer().path()+'"]'),e=i.getNodeTreeHeight(b.eContainer()),f=d.select(".bg").asPX("width")-20;if(c&&d){c.select(".bg").attr({width:f}),r.editor.selectAll('.comp[data-path="'+a+'"] > text').attr({x:f/2,"clip-path":"url(#comp-clip-"+e+")"});var g=3;b.typeDefinition.required.array.forEach(function(a){var b=c.select('.required[data-name="'+a.name+'"]');b.transform("t"+(f-g)+","+b.transform().localMatrix.f)}),this.updateValidity(b)}}else this.createComponent(b)},getSelected:function(){return this.editor.selectAll(".selected").items.map(function(a){return a.parent()})},getSelectedPaths:function(){return this.getSelected().map(function(a){return a.attr("data-path")})},getSelectedNodes:function(){return this.editor.selectAll(".node > .selected").items.map(function(a){return a.parent()})},getNodePathAtPoint:function(a,b){var c=this.getEditorContainer(),d=r.getHoveredNode(a-c.offsetLeft,b-c.offsetTop);return d?d.attr("data-path"):null},getEditorContainer:function(){return document.getElementById("editor-container")},selectAll:function(){this.editor.selectAll(".bg").items.forEach(function(a){a.addClass("selected")})},isSelected:function(a){var b=this.editor.select('.instance[data-path="'+a+'"]');return!(!b||!b.select(".bg").hasClass("selected"))},setDropTarget:function(a){this.dropTarget=a},getDropTarget:function(){return this.dropTarget},setModel:function(a){this.model=a,this.editor&&(b.updateSVGDefs(a),this.editor.clear())},getHoveredNode:function(a,c,d){var e=this.editor.transform().localMatrix;return this.editor.selectAll(".node").items.filter(function(f){return d?f.attr("data-path")!==d&&b.isPointInsideElem(f,a,c,e):b.isPointInsideElem(f,a,c,e)}).sort(function(a,b){return a.getBBox().width-b.getBBox().width})[0]},getHoveredChan:function(a,b){for(var c=this.editor.selectAll(".chan").items,d=0;d<c.length;d++)if(Snap.path.isPointInsideBBox(c[d].getBBox(),a,b))return c[d];return null},getHoveredPort:function(a,c){for(var d=this.editor.selectAll(".port").items,e=0;e<d.length;e++)if(b.isPointInsideElem(d[e],a,c,this.editor.transform().localMatrix))return d[e];return null},hasErrors:function(){return this.editor.selectAll(".invalid-icon").length>0},order:function(){this.editor.selectAll(".binding").forEach(function(a){a.node.parentNode.appendChild(a.node)})}};return Snap.plugin(function(a,c){var d=function(a,c,d){if(!this.parent().hasClass("instance")){var e=angular.element(r.editor.node).find("> .instance");this.node.parentNode.insertBefore(this.node,e[e.length-1].nextSibling)}this.data("dragStartX",a),this.data("dragStartY",c),r.draggedInstancePath=this.attr("data-path");var f=this.data("dragStart");if(f&&f.forEach(function(b){b.apply(this,[a,c,d])}.bind(this)),this.hasClass("comp")||this.hasClass("node")){var g=b.getAbsoluteBBox(this);this.data("ot","t"+g.x+","+g.y)}else this.data("ot",this.transform().local);this.data("hasMoved",!1)},e=function(a,b,c,d,e){var f=this.data("dragStartX"),g=this.data("dragStartY");if("undefined"!=typeof f&&"undefined"!=typeof g)if("object"==typeof a&&"touchmove"===a.type&&(e=a,c=e.changedTouches[0].clientX,d=e.changedTouches[0].clientY,a=c-f,b=d-g),this.transform(this.data("ot")+(this.data("ot")?"T":"t")+[a,b]),this.data("hasMoved")){var h=this.data("dragMove");h&&h.forEach(function(f){f.apply(this,[a,b,c,d,e])}.bind(this))}else{this.data("hasMoved",!0);var i=this.data("firstDragMove");i&&i.forEach(function(f){f.apply(this,[a,b,c,d,e])}.bind(this))}},f=function(){var a=arguments;if(this.data("hasMoved")){var b=r.model.findByPath(this.attr("data-path"));if(b){var c=b.findMetaDataByID(l);c||(c=j.createValue(),c.name=l,b.addMetaData(c));var d=this.transform().localMatrix;c.value=JSON.stringify({x:d.e,y:d.f})}var e=this.data("dragEnd");e&&e.forEach(function(b){b.apply(this,a)}.bind(this)),this.data("hasMoved",!1)}this.removeData("dragStartX"),this.removeData("dragStartY"),this.removeData("ot"),r.draggedInstancePath=null};c.prototype.draggable=function(){return this.drag(function(a,b,c,d,f){1===f.which&&e.apply(this,arguments)},function(a,b,c){1===c.which&&d.apply(this,arguments)},function(a){1===a.which&&f.apply(this,arguments)})},c.prototype.dragStart=function(a){var b=this.data("dragStart")||[];return b.push(a),this.data("dragStart",b)},c.prototype.dragEnd=function(a){var b=this.data("dragEnd")||[];return b.push(a),this.data("dragEnd",b)},c.prototype.dragMove=function(a){var b=this.data("dragMove")||[];return b.push(a),this.data("dragMove",b)},c.prototype.startPtDrag=function(a){return this.data("startPtDrag",a)},c.prototype.endPtDrag=function(a){return this.data("endPtDrag",a)},c.prototype.firstDragMove=function(a){var b=this.data("firstDragMove")||[];return b.push(a),this.data("firstDragMove",b)},c.prototype.selectable=function(a){var b=function(b){1===b.which&&(b.cancelBubble=!0,b.ctrlKey||b.shiftKey||r.editor.selectAll(".selected").forEach(function(a){a.removeClass("selected");var b=a.parent().attr("data-path");if(b&&b.length>0){var c=r.model.findByPath(b);i.setSelected(c,!1)}}),b.ctrlKey||b.shiftKey?(this.select(".bg").toggleClass("selected"),this.select(".bg").hasClass("selected")?i.setSelected(a,!0):i.setSelected(a,!1)):(this.select(".bg").addClass("selected"),i.setSelected(a,!0)))};return this.mousedown(b).touchstart(b)},c.prototype.relocate=function(a){var b=a.findMetaDataByID(l),c={x:100,y:100};if(b)try{c=JSON.parse(b.value)}catch(a){c={x:100,y:100}}else b=j.createValue(),b.name=l,b.value=JSON.stringify(c),a.addMetaData(b);return this.transform("t"+c.x+","+c.y)}}),r}]),angular.module("editorApp").constant("GROUP_RADIUS",55).constant("GROUP_PLUG_RADIUS",10).constant("NODE_WIDTH",210).constant("NODE_HEIGHT",50).constant("COMP_HEIGHT",40).constant("CHANNEL_RADIUS",12).constant("INVALID_RADIUS",5),angular.module("editorApp").factory("uiCreateBinding",["uiUtils","CHANNEL_RADIUS",function(a,b){return function(c,d){if(d.hub&&d.port){var e=c.editor.select('.comp[data-path="'+d.port.eContainer().path()+'"] .port[data-name="'+d.port.name+'"]'),f=c.editor.select('.chan[data-path="'+d.hub.path()+'"]'),g=c.editor.select('.binding[data-path="'+d.path()+'"]');if(e&&f){var h=a.computeBindingCoords(e,f);if(g){g.data("coords",h);var i=g.select(".bg").attr({d:"M"+h.chan.x+","+h.chan.y+" Q"+h.middle.x+","+h.middle.y+" "+h.port.x+","+h.port.y}),j=i.getPointAtLength(b+1);i.attr({d:"M"+j.x+","+j.y+" Q"+h.middle.x+","+h.middle.y+" "+h.port.x+","+h.port.y})}else{var k=c.editor.path("M"+h.chan.x+","+h.chan.y+" Q"+h.middle.x+","+h.middle.y+" "+h.port.x+","+h.port.y).attr({fill:"none",stroke:"provided"===d.port.getRefInParent()?"#ECCA40":"#C60808",strokeWidth:5,strokeLineCap:"round",strokeLineJoin:"round",opacity:.7,class:"bg"}).mouseover(function(){this.attr({opacity:.85,strokeWidth:6})}).mouseout(function(){this.attr({opacity:.7,strokeWidth:5})}),l=k.getPointAtLength(b+1);k.attr({d:"M"+l.x+","+l.y+" Q"+h.middle.x+","+h.middle.y+" "+h.port.x+","+h.port.y}),c.editor.group().attr({class:"binding","data-path":d.path()}).data("coords",h).append(k).selectable().firstDragMove(function(){this.appendTo(c.editor)}).startPtDrag(function(a,c){var d=this.data("coords"),e=d.chan.x+a,f=d.chan.y+c;d.port.x>e?d.middle.x=e+(d.port.x-e)/2:d.middle.x=d.port.x+(e-d.port.x)/2,d.middle.y=(d.port.y>=f?d.port.y:f)+20,k.attr({d:"M"+e+","+f+" Q"+d.middle.x+","+d.middle.y+" "+d.port.x+","+d.port.y});var g=k.getPointAtLength(b+1);k.attr({d:"M"+g.x+","+g.y+" Q"+d.middle.x+","+d.middle.y+" "+d.port.x+","+d.port.y})}).endPtDrag(function(a,c){var d=this.data("coords"),e=d.port.x+a,f=d.port.y+c;e>d.chan.x?d.middle.x=d.chan.x+(e-d.chan.x)/2:d.middle.x=e+(d.chan.x-e)/2,d.middle.y=(f>=d.chan.y?f:d.chan.y)+20,k.attr({d:"M"+d.chan.x+","+d.chan.y+" Q"+d.middle.x+","+d.middle.y+" "+e+","+f});var g=k.getPointAtLength(b+1);k.attr({d:"M"+g.x+","+g.y+" Q"+d.middle.x+","+d.middle.y+" "+e+","+f})}).dragEnd(function(){var b=c.editor.select('.comp[data-path="'+d.port.eContainer().path()+'"] .port[data-name="'+d.port.name+'"]'),e=c.editor.select('.chan[data-path="'+d.hub.path()+'"]');this.data("coords",a.computeBindingCoords(b,e))})}}}}}]),angular.module("editorApp").factory("uiCreateChannel",["kModelHelper","uiUtils","util","CHANNEL_RADIUS",function(a,b,c,d){return function(e,f){e.removeUIElem(f.path()),b.updateSVGDefs(e.model);var g=e.editor.circle(0,0,d).attr({fill:"#DB661D",stroke:c.isTruish(f.started)?"#fff":"#000",strokeWidth:2,class:a.isSelected(f)?"bg selected":"bg",opacity:.75,title:f.name+": "+f.typeDefinition.name}),h=e.editor.group().attr({class:"instance chan","data-path":f.path()}).append(g).selectable(f).draggable().dragMove(function(){var a=arguments;f.bindings.array.forEach(function(b){var c=e.editor.select('.binding[data-path="'+b.path()+'"]');c.data("startPtDrag").apply(c,a)})}).dragEnd(function(){var a=arguments;f.bindings.array.forEach(function(b){var c=e.editor.select('.binding[data-path="'+b.path()+'"]');c&&c.data("dragEnd").forEach(function(b){b.apply(c,a)})})}).relocate(f);g.mousemove(function(a,g,i){clearTimeout(this.data("showName"));var j=setTimeout(function(){var a,j,k=b.getPointInEditor(g,i+5),l=e.editor.getBBox().width;k.x>l/2?(j=-(2*d),a="end"):(j=2*d,a="start");var m=h.select(".name");m?m.attr({x:j,textAnchor:a}):h.append(e.editor.text(j,0,f.name+": "+f.typeDefinition.name).attr({fill:c.isTruish(f.started)?"#fff":"#000",textAnchor:a,class:"name"}))},300);this.data("showName",j)}).mouseout(function(){clearTimeout(this.data("showName"));var a=h.select(".name");a&&a.remove()}),e.updateValidity(f)}}]),angular.module("editorApp").factory("uiCreateComponent",["$modal","uiUtils","util","kFactory","kModelHelper","Notification","COMP_HEIGHT","NODE_HEIGHT",function(a,b,c,d,e,f,g,h){return function(i,j){var k,l;i.removeUIElem(j.path()),b.updateSVGDefs(i.model);var m=i.editor.select('.instance[data-path="'+j.eContainer().path()+'"]'),n=m.select(".bg").asPX("width")-20,o=b.getCompUIHeight(j),p=e.getNodeTreeHeight(j.eContainer()),q=i.editor.rect(0,0,n,o,3).attr({
fill:"black",fillOpacity:c.isTruish(j.started)?1:.65,stroke:"white",strokeWidth:1.5,class:e.isSelected(j)?"bg selected":"bg"}),r=i.editor.text(n/2,o/2,j.name).attr({fill:"white",textAnchor:"middle",class:"name","clip-path":"url(#comp-clip-"+p+")"}),s=i.editor.text(n/2,o/2+12,j.typeDefinition.name).attr({fill:"white",textAnchor:"middle","clip-path":"url(#comp-clip-"+p+")"}),t=i.editor.group().attr({class:"instance comp","data-path":j.path()}).append(q).append(r).append(s),u=3,v=0,w=0;j.typeDefinition.provided.array.forEach(function(c){var h=i.editor.rect(-8,5,10,g-10,2).attr({fill:"#bc7645",stroke:"#ECCA40",strokeWidth:2}).mouseover(function(){this.attr({strokeWidth:3})}).mouseout(function(){this.attr({strokeWidth:2})}).mousedown(function(a){a.cancelBubble=!0}).touchstart(function(a){a.cancelBubble=!0}).drag(function(a,d,f,g){var h=this.data("portPos"),k={x:0,y:0};h.x>h.x+a?k.x=h.x+a+(h.x-(h.x+a))/2:k.x=h.x+(h.x+a-h.x)/2,k.y=(h.y>=h.y+d?h.y:h.y+d)+20,this.data("binding").attr({d:"M"+h.x+","+h.y+" Q"+k.x+","+k.y+" "+(h.x+a)+","+(h.y+d)}),clearTimeout(this.data("bindingTimeout"));var l=this.data("hoveredPort");l&&l.select("text").removeClass("hovered error");var m=this.data("hoveredChan");m&&m.select(".bg").removeClass("hovered error");var n=setTimeout(function(){var k=b.getPointInEditor(f,g),l=i.getHoveredPort(k.x,k.y);if(l){this.data("hoveredChan",null),this.data("hoveredPort",l);var m=l.select("text");m.addClass("hovered"),l.hasClass("provided")&&m.addClass("error")}else{this.data("hoveredPort",null);var n=i.getHoveredChan(h.x+a,h.y+d);if(n){this.data("hoveredChan",n);var o=n.select(".bg");o.addClass("hovered");var p=i.model.findByPath(n.attr("data-path"));!e.isAlreadyBound(j.findProvidedByID(c.name),p)&&e.isCompatible(p.typeDefinition,j.eContainer())||o.addClass("error")}else this.data("hoveredChan",null)}}.bind(this),100);this.data("bindingTimeout",n)},function(){var a=l.transform().localMatrix,c=b.getAbsoluteBBox(t),d={x:a.e+c.x,y:a.f+c.y+(g-6)/2+3};this.data("portPos",d);var e=i.editor.path("M"+d.x+","+d.y+" "+d.x+","+d.y).attr({fill:"none",stroke:"#ECCA40",strokeWidth:5,strokeLineCap:"round",strokeLineJoin:"round",opacity:.7});this.data("binding",e)},function(){clearTimeout(this.data("bindingTimeout"));var b=j.findProvidedByID(c.name);b||(b=d.createPort(),b.name=c.name,b.portTypeRef=c,j.addProvided(b));var g=this.data("hoveredChan");if(g){var h=i.model.findByPath(g.attr("data-path"));if(g.select(".bg").hasClass("error"))h&&!e.isCompatible(h.typeDefinition,j.eContainer())&&f.error({title:"Binding error",message:"<strong>"+h.typeDefinition.name+"</strong> cannot run on platform <strong>"+e.getPlatforms(j.eContainer().typeDefinition).join("")+"</strong>",delay:1e4});else if(h){var k=d.createMBinding();k.hub=h,k.port=b,i.model.addMBindings(k)}g.select(".bg").removeClass("hovered error")}else{var l=this.data("hoveredPort");if(l){if(!l.select("text").hasClass("error")){var m=l.attr("data-name"),n=i.model.findByPath(l.parent().attr("data-path")),o=n.findRequiredByID(m);o||(o=d.createPort(),o.name=m,o.portTypeRef=n.typeDefinition.findRequiredByID(m),n.addRequired(o)),a.open({templateUrl:"scripts/app/main/editor/select-chan.modal.html",controller:"SelectChanModalCtrl",resolve:{startPort:b,endPort:o}}).result.then(function(a){if(a){var c=d.createMBinding();c.hub=a,c.port=b,i.model.addMBindings(c);var e=d.createMBinding();e.hub=a,e.port=o,i.model.addMBindings(e)}})}l.select("text").removeClass("hovered error")}}this.data("binding").remove(),this.removeData("binding"),this.removeData("bindingTimeout"),this.removeData("hoveredPort"),this.removeData("hoveredChan"),this.removeData("portPos")}),k=i.editor.text(6,g-4,c.name.substr(0,6)).attr({fill:"white",title:c.name}).append(Snap.parse("<title>"+c.name+"</title>"));l=i.editor.group().attr({class:"port provided","data-name":c.name}).append(h).append(k).transform("t"+u+","+v),t.append(l),v+=g}),j.typeDefinition.required.array.forEach(function(c){var h=i.editor.rect(-3,5,10,g-10,2).attr({fill:"#bc7645",stroke:"#C60808",strokeWidth:2}).mouseover(function(){this.attr({strokeWidth:3})}).mouseout(function(){this.attr({strokeWidth:2})}).mousedown(function(a){a.cancelBubble=!0}).touchstart(function(a){a.cancelBubble=!0}).drag(function(a,d,f,g){var h=this.data("portPos"),k={x:0,y:0};h.x>h.x+a?k.x=h.x+a+(h.x-(h.x+a))/2:k.x=h.x+(h.x+a-h.x)/2,k.y=(h.y>=h.y+d?h.y:h.y+d)+20,this.data("binding").attr({d:"M"+h.x+","+h.y+" Q"+k.x+","+k.y+" "+(h.x+a)+","+(h.y+d)}),clearTimeout(this.data("bindingTimeout"));var l=this.data("hoveredPort");l&&l.select("text").removeClass("hovered error");var m=this.data("hoveredChan");m&&m.select(".bg").removeClass("hovered error");var n=setTimeout(function(){var k=b.getPointInEditor(f,g),l=i.getHoveredPort(k.x,k.y);if(l)this.data("hoveredChan",null),this.data("hoveredPort",l),l.hasClass("required")?l.select("text").addClass("hovered error"):l.select("text").addClass("hovered");else{this.data("hoveredPort",null);var m=i.getHoveredChan(h.x+a,h.y+d);if(m){this.data("hoveredChan",m);var n=m.select(".bg");n.addClass("hovered");var o=i.model.findByPath(m.attr("data-path"));!e.isAlreadyBound(j.findRequiredByID(c.name),o)&&e.isCompatible(o.typeDefinition,j.eContainer())||n.addClass("error")}else this.data("hoveredChan",null)}}.bind(this),100);this.data("bindingTimeout",n)},function(){var a=k.transform().localMatrix,c=b.getAbsoluteBBox(t),d={x:a.e+c.x,y:a.f+c.y+(g-6)/2+3};this.data("portPos",d);var e=i.editor.path("M"+d.x+","+d.y+" "+d.x+","+d.y).attr({fill:"none",stroke:"#C60808",strokeWidth:5,strokeLineCap:"round",strokeLineJoin:"round",opacity:.7});this.data("binding",e)},function(){clearTimeout(this.data("bindingTimeout"));var b=j.findRequiredByID(c.name);b||(b=d.createPort(),b.name=c.name,b.portTypeRef=c,j.addRequired(b));var g=this.data("hoveredChan");if(g){var h=i.model.findByPath(g.attr("data-path"));if(g.select(".bg").hasClass("error"))h&&!e.isCompatible(h.typeDefinition,j.eContainer())&&f.error({title:"Binding error",message:"<strong>"+h.typeDefinition.name+"</strong> cannot run on platform <strong>"+e.getPlatforms(j.eContainer().typeDefinition).join("")+"</strong>",delay:1e4});else if(h){var k=d.createMBinding();k.hub=h,k.port=b,i.model.addMBindings(k)}g.select(".bg").removeClass("hovered error")}else{var l=this.data("hoveredPort");if(l){if(!l.select("text").hasClass("error")){var m=l.attr("data-name"),n=i.model.findByPath(l.parent().attr("data-path")),o=n.findProvidedByID(m);o||(o=d.createPort(),o.name=m,o.portTypeRef=n.typeDefinition.findProvidedByID(m),n.addProvided(o)),a.open({templateUrl:"scripts/app/main/editor/select-chan.modal.html",controller:"SelectChanModalCtrl",resolve:{startPort:b,endPort:o}}).result.then(function(a){if(a){var c=d.createMBinding();c.hub=a,c.port=b,i.model.addMBindings(c);var e=d.createMBinding();e.hub=a,e.port=o,i.model.addMBindings(e)}})}l.select("text").removeClass("hovered error")}}this.data("binding").remove(),this.removeData("binding"),this.removeData("bindingTimeout"),this.removeData("hoveredChan"),this.removeData("hoveredPort"),this.removeData("portPos")}),l=i.editor.text(-6,g-4,c.name.substr(0,6)).attr({fill:"white",textAnchor:"end",title:c.name}).append(Snap.parse("<title>"+c.name+"</title>"));k=i.editor.group().attr({class:"port required","data-name":c.name}).append(h).append(l).transform("t"+(n-u)+","+w),t.append(k),w+=g}),t.selectable(j).draggable().dragStart(function(){var a=document.getElementById("editor-container");this.data("offset",{left:a.offsetLeft,top:a.offsetTop})}).firstDragMove(function(){var a=arguments;this.data("parentNode",j.eContainer()),j.eContainer().removeComponents(j);var b=function(b){b.bindings.array.forEach(function(b){var c=i.editor.select('.binding[data-path="'+b.path()+'"]');c&&c.data("firstDragMove").forEach(function(b){b.apply(c,a)})})};j.provided.array.forEach(b),j.required.array.forEach(b)}).dragMove(function(a,b,c,d){var e=arguments;clearTimeout(this.data("dragTimeout"));var f=this.data("hoveredNode");f&&f.select(".bg").removeClass("hovered error");var g=setTimeout(function(){var a=this.data("offset"),b=i.getHoveredNode(c-a.left,d-a.top,j.path());b?(this.data("hoveredNode",b),b.select(".bg").addClass("hovered")):this.data("hoveredNode",null)}.bind(this),100);this.data("dragTimeout",g);var h=function(a){a.bindings.array.forEach(function(a){var b=i.editor.select('.binding[data-path="'+a.path()+'"]');b&&b.data("endPtDrag").apply(b,e)})};j.provided.array.forEach(h),j.required.array.forEach(h)}).dragEnd(function(){var a=this.data("hoveredNode");a?(a.select(".bg").removeClass("hovered error"),t.remove(),i.model.findByPath(a.attr("data-path")).addComponents(j)):(t.remove(),this.data("parentNode").addComponents(j)),clearTimeout(this.data("dragTimeout")),this.removeData("parentNode"),this.removeData("offset"),this.removeData("hoveredNode"),this.removeData("dragTimeout")});var x=m.selectAll('.instance[data-path="'+j.eContainer().path()+'"] > .instance').items,y=(m.select(".bg").asPX("width")-n)/2,z=h;return x.forEach(function(a){z+=a.select(".bg").asPX("height")+10}),t.transform("t"+y+","+z),m.append(t),i.updateValidity(j),t}}]),angular.module("editorApp").factory("uiCreateGroupWire",["uiUtils","util","GROUP_RADIUS",function(a,b,c){return function(b,d,e){function f(){g=b.editor.select('.group[data-path="'+d.path()+'"]'),h=b.editor.select('.node[data-path="'+e.path()+'"]'),i=b.editor.select('.group-wire[data-from="'+d.path()+'"][data-to="'+e.path()+'"]');var c=g.transform().localMatrix,f=a.getAbsoluteBBox(h);l={from:{x:0,y:0},to:{x:f.x-c.e,y:f.y-c.f},width:h.select(".bg").asPX("width"),height:h.select(".bg").asPX("height")}}var g,h,i,j,k,l={};f();var m=a.computeWireNodeAnchor(l.from,l.to,l.width,l.height);if(i)i.data("data",l),j=i.select("path").attr({d:"M"+l.from.x+","+l.from.y+" "+m.x+","+m.y}),k=j.getPointAtLength(c+2),j.attr({d:"M"+k.x+","+k.y+" "+m.x+","+m.y}),i.select("circle").attr({cx:m.x,cy:m.y});else{j=b.editor.path("M"+l.from.x+","+l.from.y+" "+m.x+","+m.y).attr({fill:"none",stroke:"#5aa564",strokeWidth:4,strokeLineCap:"round",strokeLineJoin:"round",class:"bg"}).mouseover(function(){this.attr({strokeWidth:5})}).mouseout(function(){this.attr({strokeWidth:4})});var n=b.editor.circle(m.x,m.y,4).attr({fill:"white"});g.group().attr({class:"group-wire","data-from":d.path(),"data-to":e.path()}).data("data",l).append(j).append(n).selectable().startPtDrag(function(b,d){var e=this.data("data"),f={x:e.to.x-b,y:e.to.y-d},g=a.computeWireNodeAnchor(e.from,f,e.width,e.height);j.attr({d:"M"+e.from.x+","+e.from.y+" "+g.x+","+g.y}),k=j.getPointAtLength(c+2),j.attr({d:"M"+k.x+","+k.y+" "+g.x+","+g.y}),n.attr({cx:g.x,cy:g.y})}).endPtDrag(function(b,d){var e=this.data("data"),f={x:e.to.x+b,y:e.to.y+d},g=a.computeWireNodeAnchor(e.from,f,e.width,e.height);j.attr({d:"M"+e.from.x+","+e.from.y+" "+g.x+","+g.y}),k=j.getPointAtLength(c+2),j.attr({d:"M"+k.x+","+k.y+" "+g.x+","+g.y}),n.attr({cx:g.x,cy:g.y})}).dragEnd(function(){f(),this.data("data",l)}),k=j.getPointAtLength(c+2),j.attr({d:"M"+k.x+","+k.y+" "+m.x+","+m.y})}}}]),angular.module("editorApp").factory("uiCreateGroup",["kModelHelper","uiUtils","util","GROUP_RADIUS","GROUP_PLUG_RADIUS",function(a,b,c,d,e){return function(f,g){f.removeUIElem(g.path()),b.updateSVGDefs(f.model);var h=f.editor.circle(0,0,d).attr({fill:"green",stroke:"#000",strokeWidth:3,class:a.isSelected(g)?"bg selected":"bg",opacity:.75}),i=f.editor.circle(0,d/2+e,e).attr({fill:"#f1c30f",class:"group-plug"}).mouseover(function(){this.attr({r:e+1})}).mouseout(function(){this.attr({r:e})}).drag(function(a,c,d,e){var h=this.data("plugPos");this.data("wire").attr({d:"M"+h.x+","+h.y+" "+(h.x+a)+","+(h.y+c)}),clearTimeout(this.data("wireTimeout"));var i=this.data("hoveredNode");i&&i.select(".bg").removeClass("hovered error");var j=setTimeout(function(){var a=b.getPointInEditor(d,e),c=f.getHoveredNode(a.x,a.y);if(c){this.data("hoveredNode",c);var h=c.select(".bg");h.addClass("hovered");var i=f.model.findByPath(c.attr("data-path"));g.findSubNodesByID(i.name)&&h.addClass("error")}else this.data("hoveredNode",null)}.bind(this),100);this.data("wireTimeout",j)},function(){var a=l.transform().localMatrix,b={x:a.e,y:a.f+d/2+e};this.data("plugPos",b);var c=f.editor.path("M"+b.x+","+b.y+" "+b.x+","+b.y).attr({fill:"none",stroke:"#5aa564",strokeWidth:5,strokeLineCap:"round",strokeLineJoin:"round",opacity:.7});this.data("wire",c)},function(){var a=this.data("hoveredNode");if(a){if(!a.select(".bg").hasClass("error")){var b=f.model.findByPath(a.attr("data-path"));g.findSubNodesByID(b.name)||g.addSubNodes(b)}a.select(".bg").removeClass("hovered error")}this.data("wire").remove(),clearTimeout(this.data("wireTimeout")),this.removeData("wire"),this.removeData("hoveredNode"),this.removeData("plugPos"),this.removeData("wireTimeout")}),j=f.editor.text(0,-5,g.name).attr({fill:c.isTruish(g.started)?"#fff":"#000",textAnchor:"middle",class:"name","clip-path":"url(#group-clip)"}),k=f.editor.text(0,10,g.typeDefinition.name).attr({fill:"white",textAnchor:"middle","clip-path":"url(#group-clip)"}),l=f.editor.group().attr({class:"instance group","data-path":g.path()}).append(h).append(j).append(k).append(i).selectable(g).draggable().dragMove(function(){var a=arguments;g.subNodes.array.forEach(function(b){var c=f.editor.select('.group-wire[data-from="'+g.path()+'"][data-to="'+b.path()+'"]');c&&c.data("startPtDrag").apply(c,a)})}).dragEnd(function(){var a=arguments;g.subNodes.array.forEach(function(b){var c=f.editor.select('.group-wire[data-from="'+g.path()+'"][data-to="'+b.path()+'"]');c&&c.data("dragEnd").forEach(function(b){b.apply(c,a)})})}).relocate(g);return f.updateValidity(g),i.touchstart(function(a){a.cancelBubble=!0}),i.mousedown(function(a){a.cancelBubble=!0}),l}}]),angular.module("editorApp").factory("uiUtils",["kModelHelper","NODE_HEIGHT","NODE_WIDTH","COMP_HEIGHT","CHANNEL_RADIUS","GROUP_RADIUS",function(a,b,c,d,e,f){function g(a){var c=b;return a.components.array.forEach(function(a){c+=h(a)+10}),a.hosts.array.forEach(function(a){c+=g(a)+10}),c}function h(a){return 0===a.typeDefinition.provided.size()&&0===a.typeDefinition.required.size()?d:a.typeDefinition.provided.size()>a.typeDefinition.required.size()?d*a.typeDefinition.provided.size():d*a.typeDefinition.required.size()}function i(a){return a.parent().hasClass("instance")?i(a.parent()):a.attr("data-path")}function j(a){function b(a){if(a.parent()&&a.parent().hasClass("instance")){var d=a.parent().getBBox();c.x+=d.x,c.y+=d.y,b(a.parent())}}var c=a.getBBox();return b(a),c}function k(a,b,c,d){var e=j(a);return e.x=e.x*d.a+d.e,e.y=e.y*d.a+d.f,e.width*=d.a,e.height*=d.a,b>=e.x&&b<=e.x+e.width&&c>=e.y&&c<=e.y+e.height}function l(a,b){var c=angular.element("svg#editor").offset();return{x:a-c.left,y:b-c.top}}function m(a,b,c,d){function e(){return a.x>=b.x+c/3&&a.x<=b.x+c/3*2?"middle":a.x>b.x+c/3*2?"right":"left"}function f(){return a.y>=b.y+d/3&&a.y<=b.y+d/3*2?"middle":a.y>b.y+d/3*2?"bottom":"top"}var g=f()+"-"+e();switch(g){default:case"top-left":return{x:b.x+2,y:b.y+2};case"top-middle":return{x:b.x+c/2,y:b.y};case"top-right":return{x:b.x+c-2,y:b.y+2};case"middle-left":return{x:b.x,y:b.y+d/2};case"middle-right":return{x:b.x+c,y:b.y+d/2};case"bottom-left":return{x:b.x+2,y:b.y+d-2};case"bottom-middle":return{x:b.x+c/2,y:b.y+d};case"bottom-right":return{x:b.x+c-2,y:b.y+d-2}}}function n(a,b){var c=b.transform().localMatrix,e={x:c.e,y:c.f},f=j(a.parent()),g=a.transform().localMatrix,h={x:f.x+g.e+2,y:f.y+g.f+d-5},i={x:0,y:0};return h.x>e.x?i.x=e.x+(h.x-e.x)/2:i.x=h.x+(e.x-h.x)/2,i.y=(h.y>=e.y?h.y:e.y)+20,{chan:e,port:h,middle:i}}function o(b){var d=document.getElementById("editor");if(d){var g,h=d.getElementsByTagName("defs")[0];if(!document.getElementById("group-clip")){g=document.createElementNS("http://www.w3.org/2000/svg","clipPath"),g.id="group-clip";var i=document.createElementNS("http://www.w3.org/2000/svg","circle");i.setAttribute("cx","0"),i.setAttribute("cy","0"),i.setAttribute("r",f-4+""),g.appendChild(i),h.appendChild(g)}if(!document.getElementById("chan-clip")){g=document.createElementNS("http://www.w3.org/2000/svg","clipPath"),g.id="chan-clip";var j=document.createElementNS("http://www.w3.org/2000/svg","circle");j.setAttribute("cx","0"),j.setAttribute("cy","0"),j.setAttribute("r",e-4+""),g.appendChild(j),h.appendChild(g)}var k=a.getNodeTreeHeights(b.nodes.array);k.forEach(function(a){if(!document.getElementById("node-clip-"+a)){var b=document.createElementNS("http://www.w3.org/2000/svg","clipPath");b.id="node-clip-"+a;var d=document.createElementNS("http://www.w3.org/2000/svg","rect");d.setAttribute("width",c+20*a-5+""),d.setAttribute("height","100%"),d.setAttribute("x","2"),d.setAttribute("y","0"),b.appendChild(d),h.appendChild(b)}if(!document.getElementById("comp-clip-"+a)){var e=document.createElementNS("http://www.w3.org/2000/svg","clipPath");e.id="comp-clip-"+a;var f=document.createElementNS("http://www.w3.org/2000/svg","rect");f.setAttribute("width",c+20*a-60+""),f.setAttribute("height","100%"),f.setAttribute("x","20"),f.setAttribute("y","0"),e.appendChild(f),h.appendChild(e)}})}}return{getAbsoluteBBox:j,getNodeUIHeight:g,getCompUIHeight:h,getHighestNodePath:i,isPointInsideElem:k,computeWireNodeAnchor:m,computeBindingCoords:n,updateSVGDefs:o,getPointInEditor:l}}]),angular.module("editorApp").factory("uiCreateNode",["uiUtils","util","kModelHelper","NODE_WIDTH","NODE_HEIGHT",function(a,b,c,d,e){return function(f,g){f.removeUIElem(g.path()),a.updateSVGDefs(f.model);var h=c.getNodeTreeHeight(g),i=d+20*h;g.host&&(i=d+20*(c.getNodeTreeHeight(g.host)-1));var j=a.getNodeUIHeight(g),k=f.editor.rect(0,0,i,j,8).attr({fill:"white",fillOpacity:.1,stroke:"white",strokeWidth:2,class:c.isSelected(g)?"bg selected":"bg"}),l=f.editor.text(i/2,e/2-2,g.name).attr({fill:b.isTruish(g.started)?"#fff":"#000",textAnchor:"middle",class:"name","clip-path":"url(#node-clip-"+h+")"}),m=f.editor.text(i/2,e/2+12,g.typeDefinition.name).attr({fill:"white",textAnchor:"middle","clip-path":"url(#node-clip-"+h+")"}),n=f.editor.group().attr({class:"instance node","data-path":g.path()}).append(k).append(l).append(m).selectable(g).draggable().dragStart(function(){var a=document.getElementById("editor-container");this.data("offset",{left:a.offsetLeft,top:a.offsetTop})}).firstDragMove(function(){var a=arguments;g.host&&g.host.removeHosts(g);var b=function(b){var c=function(b){var c=f.editor.select('.binding[data-path="'+b.path()+'"]');c&&c.data("firstDragMove").forEach(function(b){b.apply(c,a)})}.bind(this);b.provided.array.forEach(function(a){a.bindings.array.forEach(c)}),b.required.array.forEach(function(a){a.bindings.array.forEach(c)})}.bind(this);g.components.array.forEach(b),g.hosts.array.forEach(function a(c){c.components.array.forEach(b),c.hosts.array.forEach(a)})}).dragMove(function(a,b,c,d){var e=arguments;clearTimeout(this.data("dragTimeout"));var h=this.data("hoveredNode");h&&h.select(".bg").removeClass("hovered error");var i=setTimeout(function(){var a=this.data("offset")||{left:0,right:0},b=f.getHoveredNode(c-a.left,d-a.top,g.path());b?(this.data("hoveredNode",b),b.select(".bg").addClass("hovered")):this.data("hoveredNode",null)}.bind(this),100);this.data("dragTimeout",i);var j=function(a,b){var c=f.editor.select('.group-wire[data-from="'+a.path()+'"][data-to="'+b.path()+'"]');c&&c.data("endPtDrag").apply(c,e)};g.groups.array.forEach(function(a){j(a,g)});var k=function(a){var b=function(a){var b=f.editor.select('.binding[data-path="'+a.path()+'"]');b&&b.data("endPtDrag").apply(b,e)}.bind(this);a.provided.array.forEach(function(a){a.bindings.array.forEach(b)}),a.required.array.forEach(function(a){a.bindings.array.forEach(b)})}.bind(this);g.components.array.forEach(k),g.hosts.array.forEach(function a(b){b.components.array.forEach(k),b.groups.array.forEach(function(a){j(a,b)}),b.hosts.array.forEach(a)})}).dragEnd(function(){function a(a,b){var d=f.editor.select('.group-wire[data-from="'+a.path()+'"][data-to="'+b.path()+'"]');d&&d.data("dragEnd").forEach(function(a){a.apply(d,c)})}function b(a){function b(a){var b=f.editor.select('.binding[data-path="'+a.path()+'"]');b&&b.data("dragEnd").forEach(function(a){a.apply(b,c)})}a.provided.array.forEach(function(a){a.bindings.array.forEach(b)}),a.required.array.forEach(function(a){a.bindings.array.forEach(b)})}var c=arguments,d=this.data("hoveredNode");d&&(d.select(".bg").removeClass("hovered error"),n.remove(),f.model.findByPath(d.attr("data-path")).addHosts(g)),g.groups.array.forEach(function(b){this.removeData(b.path()),a(b,g)}.bind(this)),clearTimeout(this.data("dragTimeout")),g.components.array.forEach(b),g.hosts.array.forEach(function c(d){d.components.array.forEach(b),d.groups.array.forEach(function(b){a(b,d)}),d.hosts.array.forEach(c)}),this.removeData("dragTimeout"),this.removeData("hoveredNode"),this.removeData("offset")});if(g.host){var o=f.editor.select('.node[data-path="'+g.host.path()+'"]'),p=o.selectAll('.node[data-path="'+g.host.path()+'"] > .instance').items,q=(o.select(".bg").asPX("width")-i)/2,r=e;p.forEach(function(a){r+=a.select(".bg").asPX("height")+10}),o.append(n),n.transform("t"+q+","+r)}else n.relocate(g);f.updateValidity(g)}}]),angular.module("editorApp").factory("kInstance",["kFactory","kModelHelper",function(a,b){return{initDictionaries:function(c){c.dictionary=c.dictionary||a.createDictionary().withGenerated_KMF_ID("0.0"),c.typeDefinition.dictionaryType&&c.typeDefinition.dictionaryType.attributes.array.forEach(function(d){var e;if(b.isTruish(d.fragmentDependant)){switch(b.getTypeDefinitionType(c.typeDefinition)){case"channel":c.bindings.array.forEach(function(b){if(b.port&&!c.findFragmentDictionaryByID(b.port.eContainer().eContainer().name)){var d=a.createFragmentDictionary();d.name=b.port.eContainer().eContainer().name,c.addFragmentDictionary(d)}});break;case"group":c.subNodes.array.forEach(function(b){if(!c.findFragmentDictionaryByID(b.name)){var d=a.createFragmentDictionary();d.name=b.name,c.addFragmentDictionary(d)}})}c.fragmentDictionary.array.forEach(function(b){e=b.findValuesByID(d.name),e||(e=a.createValue(),e.name=d.name,e.value=d.defaultValue,b.addValues(e))})}else e=c.dictionary.findValuesByID(d.name),e||(e=a.createValue(),e.name=d.name,e.value=d.defaultValue,c.dictionary.addValues(e))})},initFragmentDictionaries:function(c){c.typeDefinition.dictionaryType&&c.typeDefinition.dictionaryType.attributes.array.forEach(function(d){var e;if(b.isTruish(d.fragmentDependant)){switch(b.getTypeDefinitionType(c.typeDefinition)){case"channel":c.bindings.array.forEach(function(b){if(b.port&&!c.findFragmentDictionaryByID(b.port.eContainer().eContainer().name)){var d=a.createFragmentDictionary();d.name=b.port.eContainer().eContainer().name,c.addFragmentDictionary(d)}});break;case"group":c.subNodes.array.forEach(function(b){if(!c.findFragmentDictionaryByID(b.name)){var d=a.createFragmentDictionary();d.name=b.name,c.addFragmentDictionary(d)}})}c.fragmentDictionary.array.forEach(function(b){e=b.findValuesByID(d.name),e||(e=a.createValue(),e.name=d.name,e.value=d.defaultValue,b.addValues(e))})}})}}}]),angular.module("editorApp").service("kWs",["kFactory",function(a){function b(a){return a?"/"!==a.substr(0,1)&&(a="/"+a):a="/",a}return{getModel:function(c,d,e,f){var g=!1,h=!1,i=null,j=setTimeout(function(){g=!0,h=!0;try{i.close()}catch(a){}var a=new Error("Connection with ws://"+c+":"+d+e+" timed out");f(a,null,"ws://"+c+":"+d+e)},5e3);e=b(e);try{i=new WebSocket("ws://"+c+":"+d+e),i.onopen=function(){clearTimeout(j),i.send("pull")},i.onmessage=function(b){try{var h=a.createJSONLoader(),k=h.loadModelFromString(b.data).get(0);g=!0,i.close(),setTimeout(function(){f(null,k,"ws://"+c+":"+d+e)})}catch(a){clearTimeout(j),console.warn("[ws.factory.getModel()] Error parsing model from message:"),console.warn("[ws.factory.getModel()] msg.data="+b.data),g=!0,i.close(),f(new Error("Unable to load received model from ws://"+c+":"+d+e),null,"ws://"+c+":"+d+e)}},i.onerror=function(a){h=!0,a=new Error("Unable to connect to ws://"+c+":"+d+e),clearTimeout(j),f(a,null,"ws://"+c+":"+d+e)},i.onclose=function(){if(!g&&!h){clearTimeout(j);var a=new Error("Connection with ws://"+c+":"+d+e+" closed");f(a,null,"ws://"+c+":"+d+e)}}}catch(a){clearTimeout(j),f(new Error("Unable to load received model from ws://"+c+":"+d+e),null,"ws://"+c+":"+d+e)}return i},pushModel:function(c,d,e,f,g){var h,i=!1,j=!1,k=null,l=setTimeout(function(){i=!0,j=!0;try{k.close()}catch(a){}var a=new Error("Connection with ws://"+d+":"+e+f+" timed out");g(a,null,"ws://"+d+":"+e+f)},5e3);try{var m=a.createJSONSerializer();h=m.serialize(c)}catch(a){var n=new Error("Unable to serialize current model");return g(n),null}return h&&(f=b(f),k=new WebSocket("ws://"+d+":"+e+f),k.onopen=function(){clearTimeout(l),k.send("push/"+h),i=!0,k.close(),g()},k.onerror=function(a){j=!0,a=new Error("Unable to connect to ws://"+d+":"+e+f),clearTimeout(l),g(a)},k.onclose=function(){if(!i&&!j){clearTimeout(l);var a=new Error("Connection with ws://"+d+":"+e+f+" closed");g(a,null,"ws://"+d+":"+e+f)}}),k}}}]),angular.module("editorApp").factory("kRegistry",["$http","kFactory","storage","KEVOREE_REGISTRY_URL",function(a,b,c,d){function e(a){var b;b=a.port&&a.port.length>0?parseInt(a.port):"http:"===a.protocol?80:443,TinyConf.set("registry.host",a.hostname),TinyConf.set("registry.port",b),TinyConf.set("registry.ssl","https:"===a.protocol),f=a,c.set("registry",a.toString())}var f=null,g=c.get("registry");if(g)try{e(new URL(g))}catch(a){Notification.error({title:"Kevoree Registry",message:"Stored URL in local storage is malformed. You should update it",delay:8e3})}else e(new URL(d));return{getUrl:function(){return f},setUrl:e,getAll:function(){return KevoreeRegistryApi.tdefs().then(function(a){var c={};return a.forEach(function(a){a.model=b.createJSONLoader().loadModelFromString(a.model).get(0);var d=a.model.findMetaDataByID("description");d&&(a.description=d.value);var e=c[a.namespace.name+"_"+a.name];e||(e={name:a.name,type:a.model.metaClassName(),namespace:a.namespace,versions:[]},c[a.namespace.name+"_"+a.name]=e),e.versions.push({id:a.id,version:a.version,deployUnits:a.deployUnits,model:a.model,description:a.description})}),Object.keys(c).map(function(a){return c[a]})})},addDeployUnits:function(a,c,d){var e={};return KevoreeRegistryApi.du({typeDefinition:{name:c,version:d,namespace:{name:a}}}).latest().then(function(a){e.latestDus=a.map(function(a){return a.model=b.createJSONLoader().loadModelFromString(a.model).get(0),a})}).then(function(){return KevoreeRegistryApi.du({typeDefinition:{name:c,version:d,namespace:{name:a}}}).release().then(function(a){e.releaseDus=a.map(function(a){return a.model=b.createJSONLoader().loadModelFromString(a.model).get(0),a})}).catch(function(){e.releaseDus=[]})}).then(function(){return e})}}}]),angular.module("editorApp").service("storage",function(){return{get:function(a,b){var c=localStorage.getItem(a);return c?JSON.parse(c).val:b},set:function(a,b){localStorage.setItem(a,JSON.stringify({val:b}))},remove:function(a){localStorage.removeItem(a)},clear:function(){localStorage.clear()},keys:function(){for(var a=[],b=0,c=localStorage.length;b<c;++b)a.push(localStorage.key(b));return a}}}),angular.module("editorApp").run(function(){function a(a){return{text:a.text,className:"cm-kevs-hint-elem",closeOnUnfocus:!1,render:function(b){b=angular.element(b).append(angular.element('<span class="type '+a.type+'"></span>').append(a.type.substr(0,1))).append(angular.element('<span class="text"></span>').append(a.text)),a.desc&&b.siblings(".desc").html(a.desc)}}}function b(a,b){return function(c){return{type:a,text:c.name,desc:b}}}function c(a){return a.dictionary?a.dictionary.values.array.map(b("attr")):[]}function d(a,b){if(b){var c=b.findNodesByID(a);if(c)return c;if(c=b.findGroupsByID(a))return c;if(c=b.findHubsByID(a))return c}return null}function e(a,b){if(b){if(0===a.length)return b;if(1===a.length)return d(a[0],b);if(2===a.length){var c=b.findNodesByID(a[0]);if(c)return c.findComponentsByID(a[1])}}return null}function f(a){return"org.kevoree.ContainerRoot"===a.metaClassName()?a.nodes.array.map(b("node")).concat(a.groups.array.map(b("group"))).concat(a.hubs.array.map(b("chan"))):[]}function g(a){return"org.kevoree.ContainerNode"===a.metaClassName()?a.components.array.map(b("comp")):[]}function h(a){return"org.kevoree.ComponentInstance"===a.metaClassName()?a.provided.array.map(b("input")).concat(a.required.array.map(b("output"))):[]}var i=["add","attach","bind","detach","move","network","start","stop","remove","set","unbind"],j=/^(\s*)\b(add|repo|include|remove|move|set|attach|detach|network|bind|unbind|start|stop|pause)\b/;CodeMirror.registerHelper("hint","kevscript",function(d){var k=d.getCursor(),l=d.getTokenAt(k),m=d.getLine(k.line),n=m.substr(0,l.end),o=[],p=j.exec(n);if(console.log("cursor=",k),console.log("token=",l),p){var q=p[2];console.log("statement=",q);var r=l.string.split(".").filter(function(a){return a.trim().length>0});1===r.length&&0===r[0].length&&(r=[]),console.log("path=",r);var s;switch(q){case"set":s=e(r,d.options.lint.lintedModel),s&&(o=g(s).concat(f(s)).concat(c(s)));break;case"bind":case"unbind":s=e(r,d.options.lint.lintedModel),s&&(o=g(s).concat(f(s)).concat(h(s)).filter(function(a){return 0===r.length?"node"===a.type:1===r.length?"comp"===a.type:2===r.length?"input"===a.type||"output"===a.type:void 0}));break;case"add":"delimiter"===l.type&&(o=[b("version")({name:"LATEST"}),b("version")({name:"RELEASE"})]);break;case"network":0===r.length?o=d.options.lint.lintedModel.nodes.array.map(b("node")):1===r.length?o=d.options.lint.lintedModel.findNodesByID(r[0]).networkInformation.array.map(b("network")):2===r.length&&(o=d.options.lint.lintedModel.findNodesByID(r[0]).findNetworkInformationByID(r[1]).values.array.map(b("value")));break;case"attach":case"detach":0===r.length&&(o=d.options.lint.lintedModel.nodes.array.map(b("node")).concat(d.options.lint.lintedModel.groups.array.map(b("group"))))}}else"comment"!==l.type&&(o=i.map(function(a){return{type:"statement",text:a}}));return{list:o.map(a),from:CodeMirror.Pos(k.line,k.ch),to:CodeMirror.Pos(k.line,l.end)}})}),angular.module("editorApp").run(function(){CodeMirror.defineSimpleMode("kevscript",{start:[{regex:/\/\/.*/,token:"comment"},{regex:/(%)([\w]+)(%)/,token:["ctxvarbracket","ctxvar","ctxvarbracket"]},{regex:/(%%)([\w]+)(%%)/,token:["ctxvarbracket","ctxvar","ctxvarbracket"]},{regex:/,|\/|:/,token:"delimiter"},{regex:/(\s*)\b(add|repo|include|remove|move|set|attach|detach|network|bind|unbind|start|stop|pause)\b/,token:[null,"statement"],sol:!0},{regex:/LATEST|RELEASE/,token:"constant"},{regex:/[A-Z]([a-zA-Z0-9]*)?/,token:"typedef"},{regex:/[a-z][\w-]*(\.[a-z][\w-]*)*\.(?=[A-Z])/,token:"namespace"},{regex:/'/,token:"string",next:"singlequote"},{regex:/"/,token:"string",next:"doublequote"},{regex:/[a-z][\w]*\.[a-z][\w]*\.([a-z][\w]*)?/,token:"instancepath"},{regex:/[a-z][\w]*\.([a-z][\w]*)?/,token:"instancepath"},{regex:/[a-z][\w]*/,token:"instancepath"},{regex:/[0-9]+/,token:"version"},{regex:/\*/,token:"wildcard"}],singlequote:[{regex:/\\./,token:"escaped"},{regex:/'/,token:"string",next:"start"},{regex:/[^\\']*/,token:"string"}],doublequote:[{regex:/\\./,token:"escaped"},{regex:/"/,token:"string",next:"start"},{regex:/[^\\"]*/,token:"string"}],meta:{lineComment:"//"}})}),angular.module("editorApp").run(["kScript","kEditor",function(a,b){function c(a,b){for(var c=-1,d=0;d<b.length;d++)if(a[0]>=b[d].start&&a[1]<=b[d].end){c=b[d].line;break}return c}function d(a,b){for(var c=0,d=0;d<b.length;d++){var e=c+(b[d].end-b[d].start)+1;if(e>a)return a-c;c=e}return a-c}var e=["repoToken","includeToken","addToken","removeToken","moveToken","setToken","attachToken","detachToken","networkToken","bindToken","unbindToken","namespaceToken","startToken","stopToken","pauseToken","comment"];CodeMirror.registerHelper("lint","kevscript",function(f){return function(g,h,i,j){CodeMirror.signal(j,"lintStart");var k=0,l=g.split("\n").map(function(a,b){var c={start:k,end:k+a.length,line:b};return k+=a.length+1,
c});a.parse(g,b.getModel(),f,function(a,b,f){var g,k=[];if(a)if(a.nt){var m="Unable to match '"+a.nt+"'";"ws"===a.nt?m="Unable to match 'whitespace'":"kevScript"===a.nt?m="A line must start with a statement (add, attach, set, etc.)":e.indexOf(a.nt)>=0&&(m="Expected statement or comment (do you mean '"+a.nt.split("Token").shift()+"'?)"),k.push({severity:"error",message:m,from:CodeMirror.Pos(a.line-1,0===a.col?0:a.col-1),to:CodeMirror.Pos(a.line-1,0===a.col?1:a.col)})}else if(a.pos){var n=c(a.pos,l);k.push({severity:"error",message:a.message,from:CodeMirror.Pos(n,d(a.pos[0],l)),to:CodeMirror.Pos(n,d(a.pos[1],l))})}else g=a;else i.lintedModel=b;f.forEach(function(a){var b=c(a.pos,l);k.push({severity:"warning",message:a.message,from:CodeMirror.Pos(b,d(a.pos[0],l)),to:CodeMirror.Pos(b,d(a.pos[1],l))})}),CodeMirror.signal(j,"lintDone",g,k,b),h(j,k)})}})}]),angular.module("editorApp").directive("onData",["$parse",function(a){return{restrict:"A",scope:!1,link:function(b,c,d){var e=a(d.onData);c.on("change",function(a){var c=new FileReader;c.onload=function(c){b.$apply(function(){e(b,{$data:c.target.result,$name:a.target.files[0].name})})};try{c.readAsText(a.target.files[0])}catch(a){}}),c.on("click",function(){this.value=null})}}}]),angular.module("editorApp").directive("dropTarget",["$parse",function(a){return{restrict:"A",scope:!1,link:function(b,c,d){function e(a){if(a.preventDefault(),a.stopPropagation(),j=0,angular.element("#"+k).remove(),a.dataTransfer&&a.dataTransfer.files.length){var c=a.dataTransfer.files[0],d=new FileReader;d.onloadend=function(a){b.$apply(function(){i(b,{$event:a,$data:a.target.result,$name:c.name})})},d.readAsText(c)}}function f(a){a.preventDefault(),a.stopPropagation()}function g(a){a.preventDefault(),a.stopPropagation(),j++,1===j&&c.append(angular.element("<div>",{id:k,class:"overlay"}).append(angular.element("<p>",{class:"center-message"}).html("Drop to load the model")))}function h(a){a.preventDefault(),a.stopPropagation(),j--,0===j&&c.find("#"+k).remove()}var i=a(d.dropTarget),j=0,k="id_"+Math.floor(1e4*Math.random()+1);c[0].addEventListener("dragenter",g,!1),c[0].addEventListener("dragleave",h,!1),c[0].addEventListener("dragover",f,!1),c[0].addEventListener("drop",e,!1),b.$on("$destroy",function(){c[0].removeEventListener("dragenter",g),c[0].removeEventListener("dragleave",h),c[0].removeEventListener("dragover",f),c[0].removeEventListener("drop",e)})}}}]),angular.module("editorApp").directive("focus",["$timeout",function(a){return{restrict:"A",link:function(b,c,d){b.$watch(d.focus,function(b){var d,e;angular.isNumber(b)?(d=b,e=!0):(d=0,e=Boolean(b)),e&&a(function(){c[0].focus(),"function"==typeof c[0].select&&c[0].select()},d)})}}}]),angular.module("editorApp").directive("truncate",["$sce",function(a){return{restrict:"E",scope:{content:"=",length:"="},template:'<p class="text-justify" ng-bind-html="trustedHtml"></p><a ng-if="expandable" href ng-click="toggle()">{{ toggleTxt }}</a>',link:function(b){function c(){function c(){g=b.content.substr(0,f),b.expandable&&(g+="..."),e=!1,b.toggleTxt="Read more",b.trustedHtml=a.trustAsHtml(g)}function d(){g=b.content,e=!0,b.toggleTxt="Reduce",b.trustedHtml=a.trustAsHtml(g)}var e=!0,f=200;angular.isNumber(b.length)&&(f=b.length);var g;b.expandable=b.content.length>f,b.toggleTxt="Reduce",b.toggle=function(){e?c():d()},c()}var d=b.$watch("content",c),e=b.$watch("length",c);b.$on("$destroy",function(){d(),e()})}}}]),angular.module("editorApp").filter("trustHtml",["$sce",function(a){return function(b){return a.trustAsHtml(b)}}]),angular.module("editorApp").factory("saveFile",function(){return{save:function(a,b,c,d){b=b||"model"+(Math.floor(900*Math.random())+100),c=c||".txt",d=d||"text/plain";var e=new Blob([a],{type:d}),f=document.createElement("a");f.download=b+c,f.innerHTML="Download File",navigator.userAgent.toLowerCase().indexOf("chrome")>-1?f.href=URL.createObjectURL(e):(f.href=URL.createObjectURL(e),f.onclick=function(a){document.body.removeChild(a.target)},f.style.display="none",document.body.appendChild(f)),f.click()}}}),angular.module("editorApp").factory("util",function(){function a(a){return"true"===a||a>0||a===!0}function b(a){a=a||5;for(var b="",c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",d=0;d<a;d++)b+=c.charAt(Math.floor(Math.random()*c.length));return b}function c(a,b){return"number"!=typeof a&&(a=0),"number"!=typeof b&&(b=65535),Math.floor(Math.random()*(b-a+1))+a}function d(){return Math.random()<.5}function e(a){for(var b=a.concat(),c=0;c<b.length;++c)for(var d=c+1;d<b.length;++d)b[c]===b[d]&&b.splice(d--,1);return b}return{isTruish:a,randomString:b,randomNumber:c,randomBoolean:d,arrayUnique:e}}),angular.module("editorApp").filter("camelize",function(){return function(a){if("string"==typeof a)return a.replace(/(?:^|[-_])(\w)/g,function(a,b){return b?b.toUpperCase():""});throw new Error("Camelize filter must be used on string only")}}),angular.module("editorApp").factory("kModelHelper",["kFactory","KWE_POSITION","KWE_TAG","KWE_SELECTED","KWE_FOLDED",function(a,b,c,d,e){function f(a,b,c){"undefined"==typeof c&&(c=0);var d,e=a.name+"_"+c;switch(b){case"node":d=a.eContainer().findNodesByID(e),d&&(e=f(a,b,++c));break;case"group":d=a.eContainer().findGroupsByID(e),d&&(e=f(a,b,++c));break;case"channel":d=a.eContainer().findHubsByID(e),d&&(e=f(a,b,++c));break;case"component":d=a.eContainer().findComponentsByID(e),d&&(e=f(a,b,++c))}return e}return{genPkgName:function(a){function b(a){a.eContainer()&&(c=a.name+"."+c,b(a.eContainer()))}var c=a.name;return b(a.eContainer()),c},getFqn:function(a){var b=this.genPkgName(a.eContainer());return"org.kevoree.library"===b?b="":b+=".",b+a.name+"/"+a.version},getTypeDefinitionType:function(a){if(a)switch(a.metaClassName()){case"org.kevoree.NodeType":return"node";case"org.kevoree.GroupType":return"group";case"org.kevoree.ComponentType":return"component";case"org.kevoree.ChannelType":return"channel"}return null},findBestVersion:function(a){for(var b=a[0],c=1;c<a.length;c++)parseInt(b.version,10)<=parseInt(a[c].version,10)&&(b=a[c]);return b},getPlatforms:function(a){var b=[];return a&&a.deployUnits.array.forEach(function(a){var c=a.findFiltersByID("platform");c&&b.indexOf(c.value)===-1&&b.push(c.value)}),b},getTags:function(a){var b=[],d=a.findMetaDataByID(c);return d&&d.value.length>0&&(b=d.value.split(",")),b},getNodeTreeHeight:function a(b){if(0===b.hosts.size())return 0;var c=b.hosts.array.map(a),d=0;return c.forEach(function(a){a>d&&(d=a)}),d+1},getNodeTypes:function(a){return a.select("**/typeDefinitions[*]").array.filter(function(a){return"org.kevoree.NodeType"===a.metaClassName()})},getGroupTypes:function(a){return a.select("**/typeDefinitions[*]").array.filter(function(a){return"org.kevoree.GroupType"===a.metaClassName()})},getComponentTypes:function(a){return a.select("**/typeDefinitions[*]").array.filter(function(a){return"org.kevoree.ComponentType"===a.metaClassName()})},getChannelTypes:function(a){return a.select("**/typeDefinitions[*]").array.filter(function(a){return"org.kevoree.ChannelType"===a.metaClassName()})},getNodeTreeHeights:function(a){var b=[];return a.forEach(function(a){var c=this.getNodeTreeHeight(a);b.indexOf(c)===-1&&b.push(c)}.bind(this)),b},getCompDepth:function(a){function b(a){a.host&&(c+=1,b(a.host))}var c=0;return b(a.eContainer()),c},getNbInstances:function(a){return this.getNbNodes(a)+this.getNbGroups(a)+this.getNbChannels(a)+this.getNbComponents(a)},getNbNodes:function(a){return a.nodes.array.length},getNbGroups:function(a){return a.groups.array.length},getNbChannels:function(a){return a.hubs.array.length},getNbComponents:function(a){var b=0;return a.nodes.array.forEach(function(a){b+=a.components.array.length}),b},getHighestNode:function(a){switch(a.getRefInParent()){case"components":return this.getHighestNode(a.eContainer());case"hosts":return this.getHighestNode(a.host);case"nodes":return a.host?this.getHighestNode(a.host):a}},isCompatible:function(a,b){if(a&&b){if(a.select("metaData[name=virtual]").array.length>0)return!0;var c=[];b.typeDefinition.deployUnits.array.forEach(function(a){var b=a.findFiltersByID("platform");b&&c.push(b.value)});for(var d=0;d<c.length;d++)if(a.select("deployUnits[name=*]/filters[name=platform,value="+c[d]+"]").array.length>0)return!0}return!1},isAlreadyBound:function(a,b){var c=!1;if(a)for(var d=0;d<a.bindings.array.length;d++)if(a.bindings.array[d].hub&&a.bindings.array[d].hub.path()===b.path())return!0;return c},isTruish:function(a){return a===!0||"true"===a||a>0},isValid:function(a){if(a.typeDefinition&&a.typeDefinition.dictionaryType&&a.typeDefinition.dictionaryType.attributes.array.length>0)if(a.dictionary&&a.dictionary.values.array.length>0)for(var b=0;b<a.dictionary.values.array.length;b++){var c=a.dictionary.values.array[b],d=a.typeDefinition.dictionaryType.findAttributesByID(c.name);if(!this.isValueValid(c,d))return!1}else for(var e=0;e<a.typeDefinition.dictionaryType.attributes.array.length;e++)if(!this.isTruish(a.typeDefinition.dictionaryType.attributes.array[e].optional))return!1;return!0},isValueValid:function(a,b){return!!(this.isTruish(b.optional)||"undefined"!=typeof a.value&&null!==a.value&&0!==a.value.length)},isVirtual:function(a){if(a){if("org.kevoree.ComponentInstance"===a.metaClassName()||"org.kevoree.ContainerNode"===a.metaClassName()||"org.kevoree.Group"===a.metaClassName()||"org.kevoree.Channel"===a.metaClassName())return this.isVirtual(a.typeDefinition);if("org.kevoree.ComponentType"===a.metaClassName()||"org.kevoree.NodeType"===a.metaClassName()||"org.kevoree.GroupType"===a.metaClassName()||"org.kevoree.ChannelType"===a.metaClassName()){var b=a.findMetaDataByID("virtual");return null!==b}if("org.kevoree.MBinding"===a.metaClassName()&&a.hub)return this.isVirtual(a.hub.typeDefinition)}return!1},isChannelDistributed:function(a){var b={};return a.bindings.array.forEach(function(a){if(a.port&&a.port.eContainer()){var c=a.port.eContainer(),d=this.getHighestNode(c);b[d.path()]=!0}}.bind(this)),Object.keys(b).length>1},isSelected:function(a){if(a&&a.findMetaDataByID){var b=a.findMetaDataByID(d);if(b)return this.isTruish(b.value)}return!1},isFolded:function(a){if(a&&a.findMetaDataByID){var b=a.findMetaDataByID(e);if(b)return this.isTruish(b.value)}return!1},setSelected:function(b,c){if(b&&b.findMetaDataByID){var e=b.findMetaDataByID(d);e||(e=a.createValue(),e.name=d,b.addMetaData(e)),e.value=c}},setFolded:function(b,c){if(b){var d=b.findMetaDataByID(e);d||(d=a.createValue(),d.name=e,b.addMetaData(d)),d.value=c}},isAttributeInType:function(a,b,c){if(a.typeDefinition.dictionaryType){var d=a.typeDefinition.dictionaryType.findAttributesByID(b);return d&&d.fragmentDependant===c}return!1},getSelection:function(a){return a.select("**/metaData[name="+d+",value=true]").array.map(function(a){return a.eContainer()})},fqnToPath:function(a){a=a.split("/");var b;2===a.length&&(b=a.pop()),a=a[0].split(".");var c=a.pop();return a=0===a.length?"packages[name="+c:"packages["+a.join("]/packages[")+"]/*[name="+c,b&&(a+=",version="+b),a+="]"},pkgFqnToPath:function(a){a=a.split(".");var b=a.pop();return 0===a.length?"packages["+b+"]":"packages["+a.join("]/packages[")+"]/packages["+b+"]"},clone:function(c){function d(d){d.started=c.started;var e=c.findMetaDataByID(b);if(e){var f=JSON.parse(e.value),h=a.createValue();h.name=b,h.value=JSON.stringify({x:f.x+50,y:f.y+50}),d.addMetaData(h)}d.dictionary=g.cloneDictionary(c.dictionary)}var e,g=this;switch(this.getTypeDefinitionType(c.typeDefinition)){case"node":e=a.createContainerNode(),d(e),e.typeDefinition=c.eContainer().findByPath(c.typeDefinition.path()),e.name=f(c,"node"),c.components.array.forEach(function(a){e.addComponents(g.clone(a))}),c.hosts.array.forEach(function(a){var b=g.clone(a);c.eContainer().addNodes(b),e.addHosts(b)});break;case"group":e=a.createGroup(),d(e),e.typeDefinition=c.eContainer().findByPath(c.typeDefinition.path()),e.name=f(c,"group");break;case"channel":e=a.createChannel(),d(e),e.typeDefinition=c.eContainer().findByPath(c.typeDefinition.path()),e.name=f(c,"channel");break;case"component":e=a.createComponentInstance(),d(e),e.typeDefinition=c.eContainer().eContainer().findByPath(c.typeDefinition.path()),e.name=f(c,"component")}return e},cloneDictionary:function(b){var c=a.createDictionary().withGenerated_KMF_ID("0.0");return b&&b.values.array.forEach(function(b){var d=a.createValue();d.name=b.name,d.value=b.value,c.addValues(d)}),c}}}]),angular.module("editorApp").filter("namingPattern",["util",function(a){var b=new RegExp("\\{randomInt(:(\\d+):(\\d+))?\\}","g"),c=new RegExp("\\{randomStr(:(\\d+))?\\}","g");return function(d,e){if("string"==typeof d){"object"==typeof e&&Object.keys(e).forEach(function(a){d=d.replace(new RegExp("{"+a+"}","g"),e[a])});var f=b.exec(d),g=a.randomNumber();f&&f[2]&&f[3]&&(g=a.randomNumber(parseInt(f[2]),parseInt(f[3])));var h=c.exec(d),i=a.randomString();return h&&h[2]&&(i=a.randomString(parseInt(h[2]))),d.replace(b,g).replace(c,i)}throw new Error("namingPattern filter must be applied on string only.")}}]),angular.module("editorApp").filter("isCompatible",["kModelHelper","kEditor",function(a,b){return function(c,d,e){return"component"===d?c.filter(function(c){if(c&&c.tdef&&e){var d=a.isCompatible(c.tdef,b.getModel().findNodesByID(e));return d}return!1}):c}}]);